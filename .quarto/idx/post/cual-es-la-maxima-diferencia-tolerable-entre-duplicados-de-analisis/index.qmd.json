{"title":"¿Cuál es la máxima diferencia tolerable entre duplicados de análisis?","markdown":{"yaml":{"title":"¿Cuál es la máxima diferencia tolerable entre duplicados de análisis?","date":"2017-08-28","slug":"cual-maxima-diferencia-tolerable-entre-duplicados-analisis","summary":"En este post presentaremos dos métodos estadísticos para establecer la máxima diferencia tolerable entre duplicados de análisis. Este criterio de aceptación nos dará una una base para la construcción de cartas control de precisión","lastmod":"2022-03-26T11:49:47-03:00"},"headingText":"Límite de repetibilidad $r$ ISO 5725","containsRefs":false,"markdown":"\n\n\nUn día cualquiera en un laboratorio que aún no establece criterios de aceptación\nde precisión:\n\n- Duplicado 1 = 25.56 % Cu\n- Duplicado 2 = 25.66 % Cu\n- Diferencia = 0.10 % Cu\n\nLa diferencia observada ¿es aceptable para el laboratorio?\n\nPara responder a esta pregunta debemos considerar varias cosas:\n\n1. ¿Los duplicados fueron realizados en condiciones de repetibilidad o \nreproducibilidad?\n2. ¿Existe alguna normativa al respecto que se deba cumplir?\n3. ¿Cuál es la metodología analítica? No es lo mismo determinar Cu en \nconcentrado de cobre por electrogravimetría (método primario) que por \nFluorescencia de Rayos X.\n4. ¿Cuál es la incertidumbre del método analítico?\n5. ¿Existe algún acuerdo a nivel comercial sobre estas diferencias?\n\nPara abordar este problema tendremos que hace la suposición que \nlos duplicados fueron obtenidos en condiciones de repetibilidad, es decir: mismo\nanalista, mismo día, mismo instrumento, etc. Bajo esta premisa hay varias formas\nde estimar la máxima diferencia tolerable entre duplicados de análisis.\n\n_**Nota**: En realidad, los conceptos que mostraremos a continuación son \ncompletamente análogos para estimar la máxima diferencia tolerable en \ncondiciones de reproducibilidad. Sin embargo, dedicaremos otro post a ese tema \nespecífico._\n\nEl concepto estadístico clave para establecer la tolerancia entre duplicados\nes el límite de repetibilidad $r$.\n\n\nLa guía ISO 5725 define el límite de repetibilidad $r$ de la siguiente manera:\n\n$$\nr = 2.8\\cdot s_{r}\n$$\ny corresponde a la máxima diferencia, en valor absoluto, que puede\ntolerarse entre duplicados de análisis, obtenidos bajo condiciones de\nrepetibilidad con un 95% de confianza. Veamos:\n\n- $s_{r}$ es la desviación estándar de repetibilidad, la cual da cuenta de\nla dispersión de las diferencias entre duplicados. Ya explicaremos cómo \ncalcular este parámetro.\n\n- El factor **2.8**: aquí les exijo una prueba de fe mis hermanos, me tienen que \ncreer porque si quieren la demostración, aumentaría mucho la viscosidad \nde este post . A _grosso modo_, el factor\n2.8 tiene que ver con el 95% de confianza, nos indica que cuando se establece \nla máxima diferencia \ntolerable, está permitido que el 5% de los duplicados estén fuera del \nlímite $r$, y aún el \nsistema analítico se encontraría bajo _Control Estadístico_.\n\n\n# ¿Cómo obtenemos la precisión de repetibilidad $s_{r}$?\n\nExisten varios métodos estadísticos para abordar la estimación de la \ndesviación estándar de repetibililidad $s_{r}$, sin embargo, en este post\nnos enfocaremos en los dos más utilizados en química analítica:\n\n1. Estimación basada en el registro histórico de duplicados de análisis.\n\n2. La estimación mediante estudios de precisión siguiendo las directrices de la\nguía ISO 5725.\n\nNo describiremos todos los detalles de cada uno de los diseños experimentales\nexpuestos en estas guías, más bien, ejemplificaremos el cálculo de la desviación\nestándar de repetibilidad $s_{r}$:\n\n# Método de estimación en base a datos históricos de duplicados\n\nObviamente necesitamos crear una base de datos con los registros de análisis\nde muestras en duplicados en condiciones de repetibilidad. Estas muestras \npueden corresponder a muestras de clientes, materiales de referencia primarios\no secundarios, muestras control, etc. Lo importante es que ambos duplicados \ncumplan con las condiciones de repetibilidad. La tabla \\@ref(tab:bdsr) es un\nejemplo de una base de datos a utilizar en este método:\n\n```{r bdsr, echo = F, message=F, warning=F}\nlibrary(knitr)\nlibrary(kableExtra)\nlibrary(tidyverse)\nlibrary(readxl)\n# library(xlsx)\n\noptions(knitr.table.format = 'html',\n        knitr.kable.NA = '') \n\n\n\ndup <- read_excel('base_datos_duplicados.xlsx', sheet = 'duplicados')\nd <- dup$dup1 - dup$dup2\nsr <- sqrt(sum(d^2)/(2*dim(dup)[1]))\n\n\nkable(head(dup),\n      digits = 2,\n      align = 'c',\n      caption = 'Base de datos histórica de duplicados (sólo los primeros  6 datos)',\n      col.names = c('ID', 'Duplicado 1', 'Duplicado 2')) %>% \n    kable_styling(full_width = T)      \n\n# write.xlsx(dup, file = 'base_datos_duplicados.xlsx', row.names = F)\n\n```\n\nPuede descargar esta base de datos desde este [link](https://1drv.ms/x/s!AuF6FPVWruwDyb4zAv7amIDqVpCvYA?e=5oqkgc). \nY ahora la pregunta del millón:\n¿Cuántas muestras en duplicado necesito? Si bien es posible obtener un cálculo\n\"exacto\" del número de muestras $n$, esto está fuera del alcance de este post. \nSin embargo, podemos decir que $n > 25$ es un número inicial adecuado. \n\nUna vez construida la base de datos, se puede obtener una estimación de $s_{r}$ \nmediante la ecuación \\@ref(eq:srdup):\n\n\\begin{equation}\n  s_{r} = \\sqrt{\\frac{\\sum_{i = 1}^{n} (x_{i1} - x_{i2})^2}{2n}}\n  (\\#eq:srdup)\n\\end{equation}\n\n\nEsta ecuación puede ser fácilmente implementada en Excel pero en este post,\ncomo no, haremos los cálculos en lenguaje R. Pero antes, observe la figura\n\\@ref(fig:dup) la cual muestra un gráfico de dispersión entre Duplicado 1 ($X$)\ny Duplicado 2 ($Y$). En este caso el orden es irrelevante. Si ajustáramos un\nmodelo lineal entre ambas variables ¿Qué valores de pendiente e intercepto\ndeberíamos obtener?\n\n```{r dup, echo = F, fig.cap = 'Gráfico de dispersión entre duplicados'}\n\nlibrary(ggplot2)\n\nggplot(dup, aes(x = dup1, y = dup2)) +\n  geom_point(pch = 16, alpha = 0.3, col = 'blue', size = 2) +\n  theme_bw() +\n  xlab('Duplicado 1') +\n  ylab('Duplicado 2') +\n  geom_abline(slope = 1, intercept = 0, col = 'red')\n  \n\n```\n\n\n\n> ¡Correcto! Pendiente $\\beta_{1} = 1$ e intercepto $\\beta_{0} = 0$. La línea\nroja representa esta recta teórica.\n> Note también que la dispersión de los datos es constante en todo el rango\n> de concentración, propiedad denominada **Homocedasticidad**.\n\nEsta propiedad es deseable, sin embargo, no todos los sistemas analíticos la \nposeen. En sí misma no es una problema, sin embargo, si la varibilidad de los\nduplicados aumenta con la concentración (_heterocedasticidad_)\ntendremos que modelar esta variabilidad\nen función de la concentración en forma explícita o segmentar el rango, lo cual\nveremos en otro post.\n\nTambién advierta la presencia de datos alejados de la diagonal, es decir, \ndiferencias entre duplicados grandes. ¿Qué hacemos\ncon ellos?¿Los mantenemos o los eliminamos? \n\nSi los eliminamos, y realmente \nreflejaran la variabilidad del método, entonces subestimaríamos la \nmáxima diferencia tolerable entre duplicados, aumentando la frecuencia de \nalertas de duplicados no conformes (nos ponemos la soga al cuello solitos). \nSi los mantenemos, y realmente fueron _errores_ puntuales de medición, \nsobreestimaríamos la tolerancia y la carta control sería de poca utilidad \n(mágicamente todos los datos caerían siempre dentro del los límites).\nEste tema lo abordaremos en otro post (llevo una lista).\n\nComo dato \"anecdótico\" en las operaciones de _trading_  en el mercado mundial\nde concentrado de cobre, la máxima diferencia tolerable entre resultados de\ndistintos laboratorios (a.k.a exportador v/s importador) es 0,20 % Cu. Si la\ndiferencia supera este límite, ambos negociadores se van a un arbitraje \n(multiplique 0,2 % Cu por la millones de toneladas que se transan en el mercado...a \n$X$ US/libra no es un asunto trivial).\n\n\nUtilizando los datos históricos estimamos una desviación \nestándar de repetibilidad de $s_{r} = `r round(sr, 2)`$ % Cu. Por lo tanto,\nel límite de repetibilidad es obtenido de la ecuación \\@ref(eq:limr):\n\n\\begin{eqnarray}\n  r &=& 2.8\\cdot s_{r} \\\\\n  r &=& 2.8\\cdot `r round(sr, 2)` \\\\\n  r &=& `r round(2.8*sr, 2)`\\, \\text{% Cu}\n  (\\#eq:limr)\n\\end{eqnarray}\n\n> **Interpretación**: La máxima diferencia tolerable, en valor absoluto,\n> entre duplicados de análisis en condiciones de repetibilidad es\n> $r = `r round(2.8*sr, 2)`$ % Cu.\n\nEntonces, dados los datos iniciales:\n\n- Duplicado 1 = 25.56 % Cu\n- Duplicado 2 = 25.66 % Cu\n- Diferencia = 0.10 % Cu\n\nLa diferencia encontrada entre duplicados \n$\\Delta = 0.1 < `r round(2.8*sr, 2)`$ % Cu, por lo tanto, se acepta \nla diferencia entre duplicados, es un dato de QAQC conforme.\n\n¿Y qué hacemos si no tenemos datos históricos de duplicados? Por favor, \ncontinue leyendo.\n\n# Estimación mediante estudios de precisión siguiendo las directrices de la guía ISO 5725\n\nCuando no existen datos históricos, la guía ISO 5725 sugiere llevar a cabo\nun diseño experimental en el cual se estudien diversos factores que podrían,\neventualmente, tener un efecto importante en la precisión del método analítico. \nPor ejemplo:\n\n- Analistas distintos\n- Equipos de medición (cromatógrafos, AAS, etc.)\n- Días distintos\n- Etc.\n\nEl \"problema\" de esta aproximación es que a medida que crece el número de\nfactores, el tamaño del diseño experimental (a.k.a número de experientos) crece\nen forma rápida incluso, en algunos diseños, en forma exponencial.\n\nLa ventaja de este método es que permite estimar en un único estudio la precisión\nde repetibilidad, reproducibilidad y la precisión intermedia, es decir, \nentre-analistas, entre-equipos, etc. La otra ventaja es que permite estimar los\ndenominados componentes de varianza \"¿Y?\" -- se preguntará.\nBueno, los componentes de varianza nos indican cuál es el factor que más aporta\na la variabilidad del sistema analítico ¿será la variabilidad entre-analistas?\n¿o los distintos equipos que dispone el laboratorio? De esta forma Ud. podrá\nfocalizar los esfuerzos y recursos en mejorar la precisión del método sólo \nen aquellos factores que más aporten a la variabilidad total.\n\nVeamos en qué consiste este método de estimación de precisión en base al \nestudio del factor **Analista**. Existen varios diseños experimentales para \nevaluar este factor, sin embargo, en este post comenzaremos con algo \n_light_:\n\n> Estimaremos la precisión de reptibilidad y reproducibilidad del método \nvolumétrico para la determinación de Cu en concentrado de cobre, \nen un laboratorio donde $n = 4$ analistas son igualmente \ncompetentes para llevar a cabo el análisis, siguiendo el mismo\ninstructivo.\n\nPara abordar este objetivo, proponemos el siguiente diseño experimental:\n\n![Diseño Experimental](doe.png){width=700px}\n\n1. Una única muestra será analizada por los $n = 4$ analistas.\n2. Cada analista realizará el análisis en quintuplicado $j = 5$\n3. Los $k = n\\cdot j = 20$ análisis deben ser obtenidos en \ncondiciones de repetibilidad\n\nSi bien podríamos publicar una enciclopedia de posts sobre diseño experimental\nen química, surgen algunas preguntas sobre este diseño en particular:\n\n- ¿Por qué una única muestra? Porque si cada analista recibiera una muestra\ndistinta, entonces la precisión del factor analista estaría \"contaminada\" \ncon la variabilidad entre muestras, la cual no nos interesa en este \nestudio.\n\n- ¿Y si una única muestra no es suficiente para llevar a cabo los 20 \nanálisis? Existen otros diseños experimentales denominados _anidados_ que \npermiten estimar la precisión utilizando muestras distintas.\n\n- ¿Por qué los análisis de cada analista deben ser obtenidos en condiciones \nde repetibilidad? Porque no queremos que otro factor no controlado (por ejemplo, \nequipos distintos) influya en la estimación de la precisión entre-analistas.\n\n- En lo posible, aumente el número de analistas en vez de hacer muchos \nreplicados. Es mejor 5 analistas en triplicado, que 3 en quintuplicado.\n\n- \"La\" muestra podría corresponder a una muestra del cliente. No es necesario\nque sea un material de referencia, sin embargo, esta\nmuestra debe ser lo suficientemente homogénea... ¡Ah, eso es trampa!\n¿Cómo demostramos que la muestra es homogénea? Le doy un dato, anote:\n\n> Si su muestra es material particulado, le tengo malas noticias: No existen\nlas muestras homogéneas de este tipo de material (gracias a san Pierre Gy \npor el dato).\n\nComo mencionamos anteriormente podríamos postear _ad infinitum_ sobre diseño\nde exprimentos en química, sin embargo, la banda ancha es finita así que \nvamos al grano. La tabla \\@ref(tab:doe) muestra los datos experimentales \ndel estudio de precisión propuesto:\n\n```{r doe, echo = F}\n\nset.seed(1994)\nanalista <- rep(paste('Analista', 1:4), each = 5)\nconcentracion <- c(rnorm(15, 25, 0.20), rnorm(5, 24.9, 0.20))\nReplicado <- rep(1:5, 4)\nprecision <- data.frame(analista, Replicado, concentracion)\n\nkable(precision %>% \n        spread(., analista, concentracion),\n      digits = 2,\n      caption = 'Resultados de estudio de precisión [% Cu]',\n      align = 'c')\n\n\n```\n\nAntes de llevar a cabo el análisis estadístico formal, observemos la figura\n\\@ref(fig:doeplot) la cual muestra el valor promedio de cada analista \n$\\pm$ 1 desviación estándar. Ella nos indica que, aparentemente, los resultados \nentre los analistas son bastante consistentes.\n\n```{r doeplot, fig.cap = 'Boxplot estudio de precisión', echo = F}\n\nsummary.precision <- precision %>% \n  group_by(analista) %>% \n  summarise(n = n(),\n          m = mean(concentracion),\n          s = sd(concentracion),\n          se = s/sqrt(n),\n          ic = qt(0.975, n - 1)*se)\n\nggplot(summary.precision, aes(x = analista, y = m)) +\n  geom_point(pch = 19, col = 'red') +\n  geom_errorbar(aes(ymin = m - s, ymax = m + s), width = 0.1) +\n  theme_bw() +\n  ylab('% Cu')\n\n```\n\n\n> Ahora bien ¿Cómo, entonces, estimamos la precisión de repetibilidad y \n> reproducibilidad a partir de la tabla \\@ref(tab:doe)? Fácil, con el \ntodopoderoso Análisis de Varianza (ANOVA).\n\nNo detallaremos la matemática detrás de esta poderosa técnica, sin embargo, \ndiremos simplemente que el ANOVA es un método cuyo propósito es particionar\nla variabilidad total de un conjunto de datos en componentes que intentan\nexplicarla. Aplicada a nuestro caso, utilizaremos ANOVA para particionar \nla variabilidad total de los 20 resultados de % Cu entre dos componentes:\n\n- El factor analista\n- La repetiblidad del método analítico.\n\npara lo cual seguiremos paso a paso las instrucciones de la guía ISO 5725.\nEn primer lugar obtendremos la tabla ANOVA mediante lenguaje `R`:\n\n```{r aov, echo = F, warning=F}\n\nlibrary(broom)\naov.precision <- aov(concentracion ~ analista, data = precision)\ns2r.doe <- tidy(aov.precision)[2, 4]\nMS.ana <- tidy(aov.precision)[1, 4]\ns2ana <- (MS.ana- s2r.doe)/5\nsR <- sqrt(s2r.doe + s2ana)\n\n\nkable(tidy(aov.precision),\n      digits = c(0, 0, 2, 2, 2, 2),\n      col.names = c('Origen Variación', \n                    'g.l', 'SQ', 'MS', 'F calculado', 'p-value'),\n      align = 'lcccccc',\n      caption = 'Tabla ANOVA precisión')\n\n```\n\nLas tablas ANOVA muy similares en casi todos los softwares estadísticos \nprofesionales... y en Excel también. Entonces:\n\n- Repetibilidad $s_{r}$: Es simplemente la raíz cuadrada del término\n$MS$ de los **Residuos**. En la nomenclatura de ANOVA es lo que se conoce como\nvariabilidad dentro (_within_). Para los datos de la tabla \\@ref(tab:doe) se obtiene \n$s_{r} = \\sqrt{\\text{MS}_{Residuals}} = \\sqrt{`r round(s2r.doe, 2)`} = `r round(sqrt(s2r.doe), 2)`$\n% Cu.\n\n- Precisión intermedia o variabilidad entre-analistas $s_{analista}$: \n¡No tan rápido! \nNo es la raíz cuadrada de $MS$ del factor analista. Debemos hacer el \nsiguiente cálculo adicional:\n\n\\begin{eqnarray}\n  s_{analista} &=& \\sqrt{\\frac{MS_{analista} - MS_{Residuals}}{j}} \\\\\n  s_{analista} &=& \\sqrt{\\frac{`r round(MS.ana, 2)` - `r round(s2r.doe, 2)`}{5}} \\\\\n  s_{analista} &=& `r round(sqrt(s2ana), 2)`\\, \\text{% Cu} \n\\end{eqnarray}\n\ndonde $j = 5$ es el número de replicados que hizo cada analista\n\n- Reproducibilidad $s_{R}$: Es simplemente la combinación en cuadratura de \nlas precisiones arriba calculadas.\n\n\\begin{eqnarray}\n  s_{R} &=& \\sqrt{s_{r}^{2} + s_{analista}^2}\\\\\n  s_{R} &=& `r round(sR, 2)`\\, \\text{% Cu}\n\\end{eqnarray}\n\n\nPor lo tanto, con estos datos podemos calcular el límite de repetibilidad\nsin necesidad de tener una base de datos histórica de duplicados. En este\ncaso $r = 2.8 s_{r} = `r round(2.8*sR, 2)`$ % Cu.\n\n> ¿Y si quisiera establecer la máxima diferencia tolerable entre analistas?\n\nNos vemos en el siguiente post.\n\n\n# _Bonus track_ : Breve historia del factor 2.8\n\nSea $x_{1}$ y $x_{2}$ los duplicados de análisis  1 y 2, respectivamente. \nCada uno de ellos \"sigue\" una distribución Normal con media $\\mu$ y \nvarianza $V = \\sigma_{r}^2$ y, además, entre ellos son _independientes_,\nentonces se cumple lo siguiente:\n\n1. la diferencia entre duplicados $\\Delta = x_{1} - x_{2}$ sigue una distribución Normal con media 0 y \nvarianza $V_{\\Delta} = V(x_{1} - x_{2}) = V(x_{1}) + V(x_{2}) = \n2\\sigma_{r}^2$.\n\n2. Si la varianza de las diferencias es $V_{\\Delta} = 2\\sigma_{r}^2$, entonces la \ndesviación estándar es $\\sqrt{2} \\sigma_{r}$. \n\n3. Por lo tanto, si quisiéramos construir un intervalo de \nconfianza al 95% para la diferencia entre duplicados obtendríamos\n$\\Delta \\pm 2\\sqrt{2} \\sigma_{r}$. El 2 es por que para una distribución Normal se\nsabe que entre la media $\\pm$ 2 la desviación estándar se encuentran aproximadamente\nel 95% de las observaciones.\n\n4. $s_{r}$ es la estimación de $\\sigma_{r}$, la cual es fija pero desconocida.\n\n5. Como $\\sqrt{2}\\approx 1,41$ entonces, con un 95% de confianza, la\ndiferencia se encuentra\nentre $\\Delta \\pm 2\\cdot 1,41 \\cdot s_{r} = 2.8\\cdot s_{r}$. Ahora imágineme como \nel mago Tamariz al final de sus actos tocando el violín ¡chiararaaá! (Si eres\n_old school_ sabrás quien es el mago Tamariz. Si eres _millenial_ mira este [video](https://www.youtube.com/watch?v=zcSqG2v-MZQ)).\n\n\n# Bibliografía\n\n1. ISO 5725 -- 3:1994 Accuracy (trueness and precision) of measurement methods and results -- Part 3: Intermediate measures of the precision of a standard measurement method\n\n2. Michael Thompson, Bertil Magnusson Methodology in internal quality control of \nchemical analysis  _Accreditation and Quality Assurance August 2013, Volume 18, \nIssue 4, pp 271–278_","srcMarkdownNoYaml":"\n\n\nUn día cualquiera en un laboratorio que aún no establece criterios de aceptación\nde precisión:\n\n- Duplicado 1 = 25.56 % Cu\n- Duplicado 2 = 25.66 % Cu\n- Diferencia = 0.10 % Cu\n\nLa diferencia observada ¿es aceptable para el laboratorio?\n\nPara responder a esta pregunta debemos considerar varias cosas:\n\n1. ¿Los duplicados fueron realizados en condiciones de repetibilidad o \nreproducibilidad?\n2. ¿Existe alguna normativa al respecto que se deba cumplir?\n3. ¿Cuál es la metodología analítica? No es lo mismo determinar Cu en \nconcentrado de cobre por electrogravimetría (método primario) que por \nFluorescencia de Rayos X.\n4. ¿Cuál es la incertidumbre del método analítico?\n5. ¿Existe algún acuerdo a nivel comercial sobre estas diferencias?\n\nPara abordar este problema tendremos que hace la suposición que \nlos duplicados fueron obtenidos en condiciones de repetibilidad, es decir: mismo\nanalista, mismo día, mismo instrumento, etc. Bajo esta premisa hay varias formas\nde estimar la máxima diferencia tolerable entre duplicados de análisis.\n\n_**Nota**: En realidad, los conceptos que mostraremos a continuación son \ncompletamente análogos para estimar la máxima diferencia tolerable en \ncondiciones de reproducibilidad. Sin embargo, dedicaremos otro post a ese tema \nespecífico._\n\nEl concepto estadístico clave para establecer la tolerancia entre duplicados\nes el límite de repetibilidad $r$.\n\n# Límite de repetibilidad $r$ ISO 5725\n\nLa guía ISO 5725 define el límite de repetibilidad $r$ de la siguiente manera:\n\n$$\nr = 2.8\\cdot s_{r}\n$$\ny corresponde a la máxima diferencia, en valor absoluto, que puede\ntolerarse entre duplicados de análisis, obtenidos bajo condiciones de\nrepetibilidad con un 95% de confianza. Veamos:\n\n- $s_{r}$ es la desviación estándar de repetibilidad, la cual da cuenta de\nla dispersión de las diferencias entre duplicados. Ya explicaremos cómo \ncalcular este parámetro.\n\n- El factor **2.8**: aquí les exijo una prueba de fe mis hermanos, me tienen que \ncreer porque si quieren la demostración, aumentaría mucho la viscosidad \nde este post . A _grosso modo_, el factor\n2.8 tiene que ver con el 95% de confianza, nos indica que cuando se establece \nla máxima diferencia \ntolerable, está permitido que el 5% de los duplicados estén fuera del \nlímite $r$, y aún el \nsistema analítico se encontraría bajo _Control Estadístico_.\n\n\n# ¿Cómo obtenemos la precisión de repetibilidad $s_{r}$?\n\nExisten varios métodos estadísticos para abordar la estimación de la \ndesviación estándar de repetibililidad $s_{r}$, sin embargo, en este post\nnos enfocaremos en los dos más utilizados en química analítica:\n\n1. Estimación basada en el registro histórico de duplicados de análisis.\n\n2. La estimación mediante estudios de precisión siguiendo las directrices de la\nguía ISO 5725.\n\nNo describiremos todos los detalles de cada uno de los diseños experimentales\nexpuestos en estas guías, más bien, ejemplificaremos el cálculo de la desviación\nestándar de repetibilidad $s_{r}$:\n\n# Método de estimación en base a datos históricos de duplicados\n\nObviamente necesitamos crear una base de datos con los registros de análisis\nde muestras en duplicados en condiciones de repetibilidad. Estas muestras \npueden corresponder a muestras de clientes, materiales de referencia primarios\no secundarios, muestras control, etc. Lo importante es que ambos duplicados \ncumplan con las condiciones de repetibilidad. La tabla \\@ref(tab:bdsr) es un\nejemplo de una base de datos a utilizar en este método:\n\n```{r bdsr, echo = F, message=F, warning=F}\nlibrary(knitr)\nlibrary(kableExtra)\nlibrary(tidyverse)\nlibrary(readxl)\n# library(xlsx)\n\noptions(knitr.table.format = 'html',\n        knitr.kable.NA = '') \n\n\n\ndup <- read_excel('base_datos_duplicados.xlsx', sheet = 'duplicados')\nd <- dup$dup1 - dup$dup2\nsr <- sqrt(sum(d^2)/(2*dim(dup)[1]))\n\n\nkable(head(dup),\n      digits = 2,\n      align = 'c',\n      caption = 'Base de datos histórica de duplicados (sólo los primeros  6 datos)',\n      col.names = c('ID', 'Duplicado 1', 'Duplicado 2')) %>% \n    kable_styling(full_width = T)      \n\n# write.xlsx(dup, file = 'base_datos_duplicados.xlsx', row.names = F)\n\n```\n\nPuede descargar esta base de datos desde este [link](https://1drv.ms/x/s!AuF6FPVWruwDyb4zAv7amIDqVpCvYA?e=5oqkgc). \nY ahora la pregunta del millón:\n¿Cuántas muestras en duplicado necesito? Si bien es posible obtener un cálculo\n\"exacto\" del número de muestras $n$, esto está fuera del alcance de este post. \nSin embargo, podemos decir que $n > 25$ es un número inicial adecuado. \n\nUna vez construida la base de datos, se puede obtener una estimación de $s_{r}$ \nmediante la ecuación \\@ref(eq:srdup):\n\n\\begin{equation}\n  s_{r} = \\sqrt{\\frac{\\sum_{i = 1}^{n} (x_{i1} - x_{i2})^2}{2n}}\n  (\\#eq:srdup)\n\\end{equation}\n\n\nEsta ecuación puede ser fácilmente implementada en Excel pero en este post,\ncomo no, haremos los cálculos en lenguaje R. Pero antes, observe la figura\n\\@ref(fig:dup) la cual muestra un gráfico de dispersión entre Duplicado 1 ($X$)\ny Duplicado 2 ($Y$). En este caso el orden es irrelevante. Si ajustáramos un\nmodelo lineal entre ambas variables ¿Qué valores de pendiente e intercepto\ndeberíamos obtener?\n\n```{r dup, echo = F, fig.cap = 'Gráfico de dispersión entre duplicados'}\n\nlibrary(ggplot2)\n\nggplot(dup, aes(x = dup1, y = dup2)) +\n  geom_point(pch = 16, alpha = 0.3, col = 'blue', size = 2) +\n  theme_bw() +\n  xlab('Duplicado 1') +\n  ylab('Duplicado 2') +\n  geom_abline(slope = 1, intercept = 0, col = 'red')\n  \n\n```\n\n\n\n> ¡Correcto! Pendiente $\\beta_{1} = 1$ e intercepto $\\beta_{0} = 0$. La línea\nroja representa esta recta teórica.\n> Note también que la dispersión de los datos es constante en todo el rango\n> de concentración, propiedad denominada **Homocedasticidad**.\n\nEsta propiedad es deseable, sin embargo, no todos los sistemas analíticos la \nposeen. En sí misma no es una problema, sin embargo, si la varibilidad de los\nduplicados aumenta con la concentración (_heterocedasticidad_)\ntendremos que modelar esta variabilidad\nen función de la concentración en forma explícita o segmentar el rango, lo cual\nveremos en otro post.\n\nTambién advierta la presencia de datos alejados de la diagonal, es decir, \ndiferencias entre duplicados grandes. ¿Qué hacemos\ncon ellos?¿Los mantenemos o los eliminamos? \n\nSi los eliminamos, y realmente \nreflejaran la variabilidad del método, entonces subestimaríamos la \nmáxima diferencia tolerable entre duplicados, aumentando la frecuencia de \nalertas de duplicados no conformes (nos ponemos la soga al cuello solitos). \nSi los mantenemos, y realmente fueron _errores_ puntuales de medición, \nsobreestimaríamos la tolerancia y la carta control sería de poca utilidad \n(mágicamente todos los datos caerían siempre dentro del los límites).\nEste tema lo abordaremos en otro post (llevo una lista).\n\nComo dato \"anecdótico\" en las operaciones de _trading_  en el mercado mundial\nde concentrado de cobre, la máxima diferencia tolerable entre resultados de\ndistintos laboratorios (a.k.a exportador v/s importador) es 0,20 % Cu. Si la\ndiferencia supera este límite, ambos negociadores se van a un arbitraje \n(multiplique 0,2 % Cu por la millones de toneladas que se transan en el mercado...a \n$X$ US/libra no es un asunto trivial).\n\n\nUtilizando los datos históricos estimamos una desviación \nestándar de repetibilidad de $s_{r} = `r round(sr, 2)`$ % Cu. Por lo tanto,\nel límite de repetibilidad es obtenido de la ecuación \\@ref(eq:limr):\n\n\\begin{eqnarray}\n  r &=& 2.8\\cdot s_{r} \\\\\n  r &=& 2.8\\cdot `r round(sr, 2)` \\\\\n  r &=& `r round(2.8*sr, 2)`\\, \\text{% Cu}\n  (\\#eq:limr)\n\\end{eqnarray}\n\n> **Interpretación**: La máxima diferencia tolerable, en valor absoluto,\n> entre duplicados de análisis en condiciones de repetibilidad es\n> $r = `r round(2.8*sr, 2)`$ % Cu.\n\nEntonces, dados los datos iniciales:\n\n- Duplicado 1 = 25.56 % Cu\n- Duplicado 2 = 25.66 % Cu\n- Diferencia = 0.10 % Cu\n\nLa diferencia encontrada entre duplicados \n$\\Delta = 0.1 < `r round(2.8*sr, 2)`$ % Cu, por lo tanto, se acepta \nla diferencia entre duplicados, es un dato de QAQC conforme.\n\n¿Y qué hacemos si no tenemos datos históricos de duplicados? Por favor, \ncontinue leyendo.\n\n# Estimación mediante estudios de precisión siguiendo las directrices de la guía ISO 5725\n\nCuando no existen datos históricos, la guía ISO 5725 sugiere llevar a cabo\nun diseño experimental en el cual se estudien diversos factores que podrían,\neventualmente, tener un efecto importante en la precisión del método analítico. \nPor ejemplo:\n\n- Analistas distintos\n- Equipos de medición (cromatógrafos, AAS, etc.)\n- Días distintos\n- Etc.\n\nEl \"problema\" de esta aproximación es que a medida que crece el número de\nfactores, el tamaño del diseño experimental (a.k.a número de experientos) crece\nen forma rápida incluso, en algunos diseños, en forma exponencial.\n\nLa ventaja de este método es que permite estimar en un único estudio la precisión\nde repetibilidad, reproducibilidad y la precisión intermedia, es decir, \nentre-analistas, entre-equipos, etc. La otra ventaja es que permite estimar los\ndenominados componentes de varianza \"¿Y?\" -- se preguntará.\nBueno, los componentes de varianza nos indican cuál es el factor que más aporta\na la variabilidad del sistema analítico ¿será la variabilidad entre-analistas?\n¿o los distintos equipos que dispone el laboratorio? De esta forma Ud. podrá\nfocalizar los esfuerzos y recursos en mejorar la precisión del método sólo \nen aquellos factores que más aporten a la variabilidad total.\n\nVeamos en qué consiste este método de estimación de precisión en base al \nestudio del factor **Analista**. Existen varios diseños experimentales para \nevaluar este factor, sin embargo, en este post comenzaremos con algo \n_light_:\n\n> Estimaremos la precisión de reptibilidad y reproducibilidad del método \nvolumétrico para la determinación de Cu en concentrado de cobre, \nen un laboratorio donde $n = 4$ analistas son igualmente \ncompetentes para llevar a cabo el análisis, siguiendo el mismo\ninstructivo.\n\nPara abordar este objetivo, proponemos el siguiente diseño experimental:\n\n![Diseño Experimental](doe.png){width=700px}\n\n1. Una única muestra será analizada por los $n = 4$ analistas.\n2. Cada analista realizará el análisis en quintuplicado $j = 5$\n3. Los $k = n\\cdot j = 20$ análisis deben ser obtenidos en \ncondiciones de repetibilidad\n\nSi bien podríamos publicar una enciclopedia de posts sobre diseño experimental\nen química, surgen algunas preguntas sobre este diseño en particular:\n\n- ¿Por qué una única muestra? Porque si cada analista recibiera una muestra\ndistinta, entonces la precisión del factor analista estaría \"contaminada\" \ncon la variabilidad entre muestras, la cual no nos interesa en este \nestudio.\n\n- ¿Y si una única muestra no es suficiente para llevar a cabo los 20 \nanálisis? Existen otros diseños experimentales denominados _anidados_ que \npermiten estimar la precisión utilizando muestras distintas.\n\n- ¿Por qué los análisis de cada analista deben ser obtenidos en condiciones \nde repetibilidad? Porque no queremos que otro factor no controlado (por ejemplo, \nequipos distintos) influya en la estimación de la precisión entre-analistas.\n\n- En lo posible, aumente el número de analistas en vez de hacer muchos \nreplicados. Es mejor 5 analistas en triplicado, que 3 en quintuplicado.\n\n- \"La\" muestra podría corresponder a una muestra del cliente. No es necesario\nque sea un material de referencia, sin embargo, esta\nmuestra debe ser lo suficientemente homogénea... ¡Ah, eso es trampa!\n¿Cómo demostramos que la muestra es homogénea? Le doy un dato, anote:\n\n> Si su muestra es material particulado, le tengo malas noticias: No existen\nlas muestras homogéneas de este tipo de material (gracias a san Pierre Gy \npor el dato).\n\nComo mencionamos anteriormente podríamos postear _ad infinitum_ sobre diseño\nde exprimentos en química, sin embargo, la banda ancha es finita así que \nvamos al grano. La tabla \\@ref(tab:doe) muestra los datos experimentales \ndel estudio de precisión propuesto:\n\n```{r doe, echo = F}\n\nset.seed(1994)\nanalista <- rep(paste('Analista', 1:4), each = 5)\nconcentracion <- c(rnorm(15, 25, 0.20), rnorm(5, 24.9, 0.20))\nReplicado <- rep(1:5, 4)\nprecision <- data.frame(analista, Replicado, concentracion)\n\nkable(precision %>% \n        spread(., analista, concentracion),\n      digits = 2,\n      caption = 'Resultados de estudio de precisión [% Cu]',\n      align = 'c')\n\n\n```\n\nAntes de llevar a cabo el análisis estadístico formal, observemos la figura\n\\@ref(fig:doeplot) la cual muestra el valor promedio de cada analista \n$\\pm$ 1 desviación estándar. Ella nos indica que, aparentemente, los resultados \nentre los analistas son bastante consistentes.\n\n```{r doeplot, fig.cap = 'Boxplot estudio de precisión', echo = F}\n\nsummary.precision <- precision %>% \n  group_by(analista) %>% \n  summarise(n = n(),\n          m = mean(concentracion),\n          s = sd(concentracion),\n          se = s/sqrt(n),\n          ic = qt(0.975, n - 1)*se)\n\nggplot(summary.precision, aes(x = analista, y = m)) +\n  geom_point(pch = 19, col = 'red') +\n  geom_errorbar(aes(ymin = m - s, ymax = m + s), width = 0.1) +\n  theme_bw() +\n  ylab('% Cu')\n\n```\n\n\n> Ahora bien ¿Cómo, entonces, estimamos la precisión de repetibilidad y \n> reproducibilidad a partir de la tabla \\@ref(tab:doe)? Fácil, con el \ntodopoderoso Análisis de Varianza (ANOVA).\n\nNo detallaremos la matemática detrás de esta poderosa técnica, sin embargo, \ndiremos simplemente que el ANOVA es un método cuyo propósito es particionar\nla variabilidad total de un conjunto de datos en componentes que intentan\nexplicarla. Aplicada a nuestro caso, utilizaremos ANOVA para particionar \nla variabilidad total de los 20 resultados de % Cu entre dos componentes:\n\n- El factor analista\n- La repetiblidad del método analítico.\n\npara lo cual seguiremos paso a paso las instrucciones de la guía ISO 5725.\nEn primer lugar obtendremos la tabla ANOVA mediante lenguaje `R`:\n\n```{r aov, echo = F, warning=F}\n\nlibrary(broom)\naov.precision <- aov(concentracion ~ analista, data = precision)\ns2r.doe <- tidy(aov.precision)[2, 4]\nMS.ana <- tidy(aov.precision)[1, 4]\ns2ana <- (MS.ana- s2r.doe)/5\nsR <- sqrt(s2r.doe + s2ana)\n\n\nkable(tidy(aov.precision),\n      digits = c(0, 0, 2, 2, 2, 2),\n      col.names = c('Origen Variación', \n                    'g.l', 'SQ', 'MS', 'F calculado', 'p-value'),\n      align = 'lcccccc',\n      caption = 'Tabla ANOVA precisión')\n\n```\n\nLas tablas ANOVA muy similares en casi todos los softwares estadísticos \nprofesionales... y en Excel también. Entonces:\n\n- Repetibilidad $s_{r}$: Es simplemente la raíz cuadrada del término\n$MS$ de los **Residuos**. En la nomenclatura de ANOVA es lo que se conoce como\nvariabilidad dentro (_within_). Para los datos de la tabla \\@ref(tab:doe) se obtiene \n$s_{r} = \\sqrt{\\text{MS}_{Residuals}} = \\sqrt{`r round(s2r.doe, 2)`} = `r round(sqrt(s2r.doe), 2)`$\n% Cu.\n\n- Precisión intermedia o variabilidad entre-analistas $s_{analista}$: \n¡No tan rápido! \nNo es la raíz cuadrada de $MS$ del factor analista. Debemos hacer el \nsiguiente cálculo adicional:\n\n\\begin{eqnarray}\n  s_{analista} &=& \\sqrt{\\frac{MS_{analista} - MS_{Residuals}}{j}} \\\\\n  s_{analista} &=& \\sqrt{\\frac{`r round(MS.ana, 2)` - `r round(s2r.doe, 2)`}{5}} \\\\\n  s_{analista} &=& `r round(sqrt(s2ana), 2)`\\, \\text{% Cu} \n\\end{eqnarray}\n\ndonde $j = 5$ es el número de replicados que hizo cada analista\n\n- Reproducibilidad $s_{R}$: Es simplemente la combinación en cuadratura de \nlas precisiones arriba calculadas.\n\n\\begin{eqnarray}\n  s_{R} &=& \\sqrt{s_{r}^{2} + s_{analista}^2}\\\\\n  s_{R} &=& `r round(sR, 2)`\\, \\text{% Cu}\n\\end{eqnarray}\n\n\nPor lo tanto, con estos datos podemos calcular el límite de repetibilidad\nsin necesidad de tener una base de datos histórica de duplicados. En este\ncaso $r = 2.8 s_{r} = `r round(2.8*sR, 2)`$ % Cu.\n\n> ¿Y si quisiera establecer la máxima diferencia tolerable entre analistas?\n\nNos vemos en el siguiente post.\n\n\n# _Bonus track_ : Breve historia del factor 2.8\n\nSea $x_{1}$ y $x_{2}$ los duplicados de análisis  1 y 2, respectivamente. \nCada uno de ellos \"sigue\" una distribución Normal con media $\\mu$ y \nvarianza $V = \\sigma_{r}^2$ y, además, entre ellos son _independientes_,\nentonces se cumple lo siguiente:\n\n1. la diferencia entre duplicados $\\Delta = x_{1} - x_{2}$ sigue una distribución Normal con media 0 y \nvarianza $V_{\\Delta} = V(x_{1} - x_{2}) = V(x_{1}) + V(x_{2}) = \n2\\sigma_{r}^2$.\n\n2. Si la varianza de las diferencias es $V_{\\Delta} = 2\\sigma_{r}^2$, entonces la \ndesviación estándar es $\\sqrt{2} \\sigma_{r}$. \n\n3. Por lo tanto, si quisiéramos construir un intervalo de \nconfianza al 95% para la diferencia entre duplicados obtendríamos\n$\\Delta \\pm 2\\sqrt{2} \\sigma_{r}$. El 2 es por que para una distribución Normal se\nsabe que entre la media $\\pm$ 2 la desviación estándar se encuentran aproximadamente\nel 95% de las observaciones.\n\n4. $s_{r}$ es la estimación de $\\sigma_{r}$, la cual es fija pero desconocida.\n\n5. Como $\\sqrt{2}\\approx 1,41$ entonces, con un 95% de confianza, la\ndiferencia se encuentra\nentre $\\Delta \\pm 2\\cdot 1,41 \\cdot s_{r} = 2.8\\cdot s_{r}$. Ahora imágineme como \nel mago Tamariz al final de sus actos tocando el violín ¡chiararaaá! (Si eres\n_old school_ sabrás quien es el mago Tamariz. Si eres _millenial_ mira este [video](https://www.youtube.com/watch?v=zcSqG2v-MZQ)).\n\n\n# Bibliografía\n\n1. ISO 5725 -- 3:1994 Accuracy (trueness and precision) of measurement methods and results -- Part 3: Intermediate measures of the precision of a standard measurement method\n\n2. Michael Thompson, Bertil Magnusson Methodology in internal quality control of \nchemical analysis  _Accreditation and Quality Assurance August 2013, Volume 18, \nIssue 4, pp 271–278_"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../styles.css","../../custom.css"],"toc":true,"output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.4.541","theme":"uniited","page-layout":"article","crossref":{"eq-prefix":"","fig-prefix":"","tbl-prefix":"","fig-title":"Figura","tbl-title":"Tabla"},"knitr":{"opts_chunk":{"warning":false,"message":false}},"title":"¿Cuál es la máxima diferencia tolerable entre duplicados de análisis?","date":"2017-08-28","slug":"cual-maxima-diferencia-tolerable-entre-duplicados-analisis","summary":"En este post presentaremos dos métodos estadísticos para establecer la máxima diferencia tolerable entre duplicados de análisis. Este criterio de aceptación nos dará una una base para la construcción de cartas control de precisión","lastmod":"2022-03-26T11:49:47-03:00"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}