{
  "hash": "9408412d8a8ef22e02dc2601d1211ef5",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Validación de los cálculos de incertidumbre en química analítica con el método Monte Carlo. Parte I\"\ndate: '2017-09-12'\nlastmod: '2022-03-26T12:37:39-03:00'\n---\n\n\n\nDe acuerdo al numeral 8.1 del Suplemento 1 de la guía GUM, \nel método de Monte Carlo es un método general para estimar la incertidumbre de\nmedición y puede, bajo ciertas directrices, validar los cálculos realizados\ncon el método GUM. En este post asumiremos que Ud.,\nesimado lector, está familiarizado con el método GUM y ya lo tiene implementado\n, por ejemplo, en una hoja Excel y le gustaría validar \nsus cálculos mediante un \nmétodo totalmente independiente y más general. De esta forma podrá cumplir\ncabalmente con el siguiente numeral de la norma 17025:\n\n> 5.4.7.1\tLos cálculos y la transferencia de los datos deben estar sujetos a \n> verificaciones adecuadas llevadas a cabo de una manera sistemática.\n\n¿Cómo sabe Ud. que su implementación en Excel está correcta?\n\n# ¿Qué es el método de Monte Carlo?\n\n(Aquí podría hacer copy-paste de Wikipedia...no olvidar borrar esta nota interna)\n\nMuy sucintamente, el método de Monte Carlo es un método numérico que permite\nevaluar expresiones matemáticas complejas (muy complejas, créame) mediante la\nsimulación de números aleatorios. \nEste post no pretende profundizar en la teoría de este método (ZzzZzz...) , sino\nmás bien dar ejemplos concretos aplicados en química analítica, por lo tanto, \nes posible que un avezado estadístico computacional le dé un infarto al leer la \nsoltura con la cual me expreso y lo ineficiente del código `R`. El objetivo\nes simplemente la divulgación a la comunidad químico-analítica para\nabordar algunos puntos normativos de la 17025 y guía GUM.\n\nVeamos un ejemplo sencillo. Supongamos que necesitamos calcular la \nincertidumbre de la \nsuma de 2 variables aleatorias\nnormales **independientes**, y que poseen  \nla misma media ($\\mu$) y varianza ($\\sigma^2$), es decir,\nsi $Z = X + Y$ ¿Cuál es la incertiumbre de $Z$? ($u_{Z}$)\n\nSi Ud. recuerda de sus cursos de probabilidades, este problema tiene una solución\ndirecta y sencilla: \n\n\\begin{eqnarray}\n  V(Z) &=& V(X) + V(Y) \\\\\n  V(Z) &=& \\sigma^2 + \\sigma^2 \\\\\n  V(Z) &=& 2\\sigma^2\n\\end{eqnarray}\n\ndonde $V()$ denota varianza. Por lo tanto, la incertidumbre de Z es \n$u_{Z} = \\sqrt{V(Z)} = \\sqrt{2}\\sigma$. Si Ud, conoce $\\sigma$, es decir, \nla incertidumbre estándar de $X$ e $Y$, el problema está resuelto. \nEn realidad, este ejemplo es bastente general y las distribuciones ni siquiera \ntienen que ser las mismas, bajo ciertas condiciones, esto se cumplirá.\n\nPero supongamos que, repentinamente, Ud. olvidó todo lo aprendido en esas \nestimulantes clases de probabilidades con 33°C y \nsin aire acondicionado. No se\npreocupe, obtendremos la incertidumbre de Z sin recurrir a ninguna propiedad\nteórica de las varianzas. Usareemos el método de Monte Carlo, \npara lo cual debemos\nhacer lo siguiente:\n\n1. Asigne a cada variable, en este caso $X$ e $Y$, una distribución de \nprobabilidad de acuerdo a la información que disponga hasta ese momento. \nEn nuestro ejemplo tanto $X$ como $Y$ son normales con \nla misma media ($\\mu$) y desviación estándar ($\\sigma$). Sin pérdida de \ngeneralidad, diremos que ambas variables $X$ e $Y$ son normales con media\n$\\mu = 100$ y desviación estándar $\\sigma = 5$.\n\n2. De cada variable genere un valor aleatorio. Es decir, en nuestro ejemplo \ndebemos generar un número aleatorio para $X$ y otro para $Y$ a partir de sus\nrespectivas distribuciones de probabilidad asignadas, que en este caso es la \nmisma. Haremos esto en lenguaje `R`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Generamos n = 1 número aletorio para X a partir de una\n# distribución Normal con media 100 y desviación estándar 5\nX <- rnorm(1, 100, 5) \n\n# Generamos n = 1 número aletorio para Y a partir de una\n# distribución Normal con media 100 y desviación estándar 5\nY <- rnorm(1, 100, 5) \n```\n:::\n\n::: {.cell}\n\n:::\n\n\nEn esta primera simulación obtuvimos $X = 97.1976218$ e $Y = 98.8491126$.\n\n3. Calcule la variable de interés con los datos simulados. En el ejemplo,\n$Z = X + Y = 97.1976218 + 98.8491126= 196.0467343$\n\n4. Repita los pasos 2 y 3 $n$ veces y obtenga la distribución empírica de $Z$.\n\n5. A partir de los $n$ datos simulados de $Z$, estime $u_{Z} = s_{Z}$, es decir,\nla desviación estándar muestral de los $n$ datos. \n\nHay varias formas de implementar todos estos pasos\nen `R`, la más intuitiva (creo yo) es la siguiente:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nn <- 1000 # Obtendremos n = 1000 datos aleatorios para X e Y\nmu <- 100 # Media mu = 100\ns <- 5    # Desviación estandar s = 5\n\nX <- rnorm(n, mu, s) # 1000 datos aleatorios de una normal con parámetros mu y s\nY <- rnorm(n, mu, s) # 1000 datos aleatorios de una normal con parámetros mu y s\n\nZ <- X + Y # Para cada uno de los 1000 datos de X e Y, calculamos Z\n\nuZ <- sd(Z) # La incertidumbre estándar de Z es la desviación estándar de las\n            # n = 1000 simulaciones\n```\n:::\n\n\n  \nEn nuestro ejemplo, la incertidumbre estándar por Monte Carlo es de\n$u_{Z}^{MC} = 7.4$. ¿Qué nos decía la teoría? Que \n$u_{Z} = \\sqrt{2}\\sigma = \\sqrt{2}\\cdot 5 = 7.1$\n\nOjalá todo fuera tan fácil. El ejemplo era muy sencillo y la \nsolución es conocida en forma teórica. \nLa vida del químico analítico es extremadamente compleja (en todo $entido),\ny no siempre existe una solución tan simple. Para eso está el método de\nMonte Carlo, el cual simula un proceso complejo cuyas variables de entrada\npueden tener cualquier distribución de probabilidad tal como lo muestra\nla siguiente figura:\n\n![](mc2.png){width=500px}\n\nLa generalidad del método MC no asume normalidad de la variable de\ninterés $g(y)$, sino más bien la estima como una distribución empírica y a \npartir de ésta calcula la incertidumbre estándar y expandida.\n\n\n# Incertidumbre de un factor de dilución\n\n\nPara aterrizar esta definición veamos un\nejemplo muy simple en química analítica\ny cómo podemos implementarlo en un lenguaje de programación\nespecialmente dedicado a esta tareas: `R`. A su vez discutiremos las principales\ndiferencias entre el método GUM y el método de Monte Carlo\n\n> Se prepara la dilución de una muestra antes de su lectura por AAS, mediante\n> la toma de una alícuota de 20 mL con una pipeta volumétrica cuyo volumen \n>  es $20,0 \\pm 0,1$ mL y su dilución en un matraz de 100 mL, \ncon un volumen de $100 \\pm 0,6$ mL. Calcular la incertidumbre\ndel factor de dilución $f = V_{final}/V_{inicial}$\n\n## Método GUM\n\nEste es un ejercicio bastante simple para el método GUM, pues el factor de \ndilución es una operación de división, por lo que aplicando las reglas de\npropagación de la incertidumbre de una división, obtenemos lo\nsiguiente:\n\n$$\n  u_{f} = f\\sqrt{\\left(\\frac{u_{V_{final}}}{V_{final}}\\right)^2 + \n  \\left(\\frac{u_{V_{inicial}}}{V_{incial}}\\right)^2}\n$${#eq-f}\n\nAsumiremos por simplicidad que las incertidumbres asociadas al material\nvolumétrico son las indicadas por el fabricante en el mismo material, es\ndecir, de acuerdo a la figura @fig-matraz y, por ahora, serán\nlas únicas fuentes de incertidumbre del material volumétrico (olvidaremos \nla T° y la repetibilidad).\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Incertidumbre del fabricante](pipeta.jpg){#fig-matraz width=84}\n:::\n:::\n\n\nAhora bien, las incertidumbres del material volumétrico corresponden a \nincertidumbres expandidas $U$, por lo tanto, debemos convertirlas a incertidumbres\nestándares antes de aplicar la ecuación @eq-f. También por simplicidad, \nmodelaremos los volúmenes mediante una distribución rectangular, por lo\ntanto, al estandarizar $u = U/k$, con $k = \\sqrt{3}$ obtenemos lo siguiente:\n\n$$\n\\begin{eqnarray}\n  u_{V_{final}} &=& \\frac{0,6}{\\sqrt{3}} = 0.35\\, \\text{mL}\\\\\n  u_{V_{incial}} &=& \\frac{0,1}{\\sqrt{3}} = 0.06\\, \\text{mL}\\\\\n  u_{f} &=& \\frac{100}{20}\\sqrt{\\left(\\frac{0.35}{100}\\right)^2 + \n  \\left(\\frac{0.06}{20}\\right)^2} \\\\\n    u_{f} &=&  0.02255\n\\end{eqnarray}\n$$\n\nEn este ejemplo, podemos asumir que los grados de libertad de ambas \nincertidumbres tienden a infinito, por lo tanto, si queremos obtener la \nincertidumbre expandida del factor de dilución con un 95% de confianza, \nse asume un factor de cobertura $k = 2$, de esta forma \nobtenemos $U_{f} = ku_{f} = 0.04509$ mL.\n\n## Método de Monte Carlo\n\nImplementaremos en `R`, los pasos descritos del método de Monte Carlo:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nk <- sqrt(3) # Factor de estandarización para una distribución rectangular\nvi <- 20     # Volumen inicial [mL]\nUvi <- 0.1   # Incertidumbre expandida del volumen inicial [mL]\nuvi <- Uvi/k # Incertidumbre estándar del volumen inicial [mL]\nvf <- 100    # Volumen incial [mL]\nUvf <- 0.6   # Incertidumbre expandida del volumen final [mL]\nuvf <- Uvf/k # Incertidumbre estándar del volumen final [mL]\n\n# Aquí haremos la simulación de Monte Carlo\nset.seed(123) # Para que Ud. obtenga los mismos resultados en su simulación\n\n# Generaremos valores aleatorios de volumen inicial y volumen final\n# desde una distribución rectangular con el comando runif(n, minimo, maximo)\n# minimo = volumen - U\n# maximos = volumen + U\n# Los guardaremos en los vectores vi.sim y vf.sim\n\nn <- 1000\nvi.sim <- runif(n, vi - Uvi, vi + Uvi)\nvf.sim <- runif(n, vf - Uvf, vf + Uvf)\n\n# Ahora calcularemos el factor de dilución para cada uno de los pares de \n# valores de volumen inicial y final que simulamos y lo guardaremos en el\n# el vector f.sim\n\nf.sim <- vf.sim/vi.sim # Es la misma fórmula\n```\n:::\n\n\n\"Bueno ¿Y?\" se preguntará Ud. \n\nVeamos que hemos generado con la simulación:\n\n1. $n = 1000$ valores aleatorios del volumen inicial a partir de una\ndistribución rectangular con media `vi` = 20 mL e incertidumbre expandida\n`Uvi` = 0.1 mL. El promedio de los 1000 volumenes iniciales simulados es\n19.999 mL y una desviación estándar de \n`uvi` = $U_{vf}/\\sqrt{3} = 0.058$ mL. La figura @fig-visim\nmuestra el histograma de los valores simulados. Note que la simulación \nconcuerda perfectamente con los valores de incertidumbre informados por el \nfabricante ($20 \\pm 0.1$ mL).\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Histograma de los valores simulados de volumen inicial [mL]](index_files/figure-html/fig-visim-1.png){#fig-visim width=672}\n:::\n:::\n\n\n2. $n = 1000$ valores aleatorios del volumen final a partir de una\ndistribución rectangular con media `vf` = 100 mL e incertidumbre expandida\n`Uvf` = 0.6 mL.\n\n3. Para cada uno de los pares datos simulados de volumen inicial y final, \nse calculó el factor de dilución, por lo tanto, se obtuvieron en total \n$n = 1000$ factores los cuales se \"guardaron\" en el \nvector `f.sim`, tal como se muestra en la tabla @tbl-fsim:\n\n\n::: {#tbl-fsim .cell}\n::: {.cell-output-display}\n\n\nTable: Variables simuladas. Se muestran los primeros 6 datos\n\n|vf.sim |vi.sim |f.sim |\n|:------|:------|:-----|\n|99.73  |19.96  |5.00  |\n|100.11 |20.06  |4.99  |\n|99.59  |19.98  |4.98  |\n|100.42 |20.08  |5.00  |\n|100.42 |20.09  |5.00  |\n|99.97  |19.91  |5.02  |\n\n\n:::\n:::\n\n\n4. La figura @fig-fsimhis muestra el histograma de los \n1000 factores de dilución simulados:\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Histograma de factores de dilución simulados](index_files/figure-html/fig-fsimhis-1.png){#fig-fsimhis width=672}\n:::\n:::\n\n\n\n\"¡Qué interesante!\", dirá Ud., la división de dos variables rectangulares\ngenera una distribución de datos que, al menos, es simétrica. ¿Es razonable\nasumir una distribución normal del factor de dilución simulado? Si recuerda\nla discusión en este \n[post](https://www.analytical.cl/post/mis-datos-no-son-normales/), \npodemos evaluar la admisibilidad de esta hipótesis mediante el análisis\ngráfico _QQ-Plot_ de normalidad de los datos simulados y el test de Shapiro, \nel cual se muestra en la figura @fig-fsimnorm.\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tShapiro-Wilk normality test\n\ndata:  f.sim\nW = 0.99005, p-value = 2.719e-06\n```\n\n\n:::\n\n::: {.cell-output-display}\n![QQ-Plot de normalidad de los n factores de dilución simulados](index_files/figure-html/fig-fsimnorm-1.png){#fig-fsimnorm width=672}\n:::\n:::\n\n\nAparentemente, el modelo normal sería razonable para modelar el factor de\ndilución sino fuera por los siguientes hechos:\n\n- El histograma del factor de dilución tiene \"colas livianas\", lo cual se puede\nadvertir en el _QQ-plot_ de normalidad en los valores extremos.\n\n\n::: {.cell}\n\n:::\n\n\n- La evidencia del test de Shapiro en contra de la hipótesis de \nnormalidad.\n\n- Y lo más importante, la razón de dos variables independientes \nrectangulares (uniformes) teóricamente no es Normal (está demostrado).\n\nOk, probablemente esta discusión no sea de mucho interés por ahora, pero\nnos dará pistas para dirigir la discusión posterior.\n\n> Entonces ¿Cómo obtenemos la incertidumbre del factor de dilución por el \n> método de Monte Carlo?\n\nMuy sencillo, a partir de la desviación estándar de los factores de dilución\nsimulados, es decir, $u_{f}^{MC} = 0.02302$.\nComo podrá advertir, es muy similar a la obtenida por el método GUM \n$u_{f} = 0.02255$, la diferencia relativa es de \nun 2.1 %. Es más, ajustando a las\ncifras significativas correctas se obtiene la misma magnitud \n0.02\n\n> ¿Queda validado el método GUM con los cálculos del método de Monte Carlo?\n> Desde el punto de vista metrológico químico: Sí.\n> Desde el punto de vista numérico: Depende. \n\nLo que sucede es que el numeral 8.1 del suplemento 1 dela guía GUM\nes explícito en establecer \nun criterio de aceptación entre el método GUM y el método de Monte Carlo (MC):\n\n\\begin{eqnarray}\n  |y - U(y) - y_{low}| &<& \\xi \\\\\n  |y + U(y) - y_{high}| &<& \\xi\n\\end{eqnarray}\n\ndonde $y \\pm U(y)$ es el valor calculado de la variable y su incertidumbre\nexpandida estimada por el método GUM; $y_{low}$ e $y_{high}$ corresponden a\nlos percentiles 2.5 y 97.5 de los datos simulados, es decir, \nel intervalo de incertidumbre al 95% de\nconfianza calculado por el método de Monte Carlo. $\\xi$ es la tolerancia \nnumérica entre ambas metodologías de cálculo. Es decir, es un test de \nprecisión numérica, no metrológica. \n\nEl valor de $\\xi$ está relacionado las cifras significativas que tienen sentido físico-químico y metrológico. Por ejemplo, si \npara una gravimetría usamos una balanza granataria cuya incertidumbre es del \norden de $\\pm 0.1$ g, no podríamos elegir una tolerancia numérica \nde $0.00001$ g. Para establecer $\\xi$ la guía indica lo siguiente:\n\n1. Exprese $u(y)$ en notación científica manteniendo las cifras\nsignificativas. En nuestro caso obtuvimos $u_{f} = 0.0225$, la cual\npuede ser redondeada a una cifra significativa $u_{f} = 0.02$.\nEsta incertidumbre, entonces, se expresa como $2 \\cdot 10^{-2}$.\n\n2. Para obtener $\\xi$, utilice el exponente de la potencia de 10 (t = -2) \ndel paso anterior, en la siguiente expresión:\n\n\\begin{eqnarray}\n  \\xi &=& \\frac{1}{2}\\times 10^{t} \\\\\n  \\xi &=& \\frac{1}{2}\\times 10^{-2}\\\\\n  \\xi &=& 0.005\n\\end{eqnarray}\n\n\n\n> ¿Cómo obtenemos los percentiles 2.5 y 97.5 de la simulación de Monte Carlo?\n\nMuy sencillo, con el comando `quantile`:\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n\nEsto quiere decir, que de los $n = 1000$ datos simulados del factor de \ndilución, un 95% se encuentra dentro del intervalo  [4.96, 5.04]. \nLa figura @fig-quantilofig muestra este intervalo en el histograma de \nlos datos simulados:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhist(f.sim, \n     xlab = 'Factor de dilución',\n     main = '',\n     freq = T,\n     breaks = 20,\n     xlim = c(4.93, 5.07))\n\nabline(v = quantilos[1], col = 'red')\nabline(v = quantilos[2], col = 'red')\n```\n\n::: {.cell-output-display}\n![Intervalo de confianza al 95% de los datos simulados del factor de dilución](index_files/figure-html/fig-quantilofig-1.png){#fig-quantilofig width=672}\n:::\n:::\n\n\nPor lo tanto, sólo nos queda calcular $U(y)$ que es la incertidumbre expandida\ndel factor de dilución calculada por el método GUM. De acuerdo a la guía\n$U = k\\cdot u$, donde $k$ es el factor de cobertura para obtener un \nintervalo de incertidumbre con cierto grado de confianza. Aquí es donde la guía\nGUM asume, bajo ciertas condiciones (ver numeral G.2.3), que la variable de \nrespuesta, en este caso factor de dilución, puede aproximarse a una distribución\nNormal donde $k \\approx 2$. Advierta que para nuestro ejemplo esta suposición \nno tiene mucho asidero. Por lo tanto, siguiendo las directrices de la guía\nGUM $U_{f} = 2\\cdot 0.023 = 0.05$.\n\nCon todos los datos estimados, llevemos a cabo el test de validación entre\nel método GUM y el método de Monte Carlo:\n\n\\begin{eqnarray}\n  |5 - 0.045 - 4.957| &<& 0.005 \\\\\n  |5 + 0.045 - 5.043| &<& 0.005\n\\end{eqnarray}\n\n> En ambos casos $0.002 < 0.005$, por lo tanto, el método GUM queda validado\n\n*Insisto con lo del mago Tamariz: ¡chiararáaa!*\n\nObservaciones:\n\n1. Si bien en este ejemplo sólo utilizamos $n = 1000$ simulaciones, en la \npráctica se requieren muchas más ($10^{5} - 10^{6}$). El suplemento 1 de la GUM\nentrega más directrices en este tema.\n\n2. Mientras mayor sea el grado de no linealidad de la ecuación de medición, \nmás divergencias habrá entre GUM y MC. Siendo este último el de mayor\ngeneralidad.\n\n\n3. Si bien se puede implementar Monte Carlo en Excel, es una tarea bastante\nengorrosa pues debe programarlo en Visual Basic. Le sugiero utilizar lenguajes\nde programación más modernos como `R` o `Python`, los cuales tienen librerías\nespecializadas en métodos de simulación.\n\n4. A mayor asimetría de la distribución empírica, mayores diferencias habrá\nentre ambos métodos.\n\n5. Dé un sentido químico a la simulación ¿[Recuerda que la pureza química no es Normal](https://www.analytical.cl/post/mis-datos-no-son-normales/)? \nIntente con la distribución Beta la cual es más apropiada\npara modelar pureza.\n\nEn este post hemos validado el método GUM frente a Monte Carlo \"a mano\", es decir,\nhemos hecho el test en forma manual. En el \n[próximo post](https://www.analytical.cl/post/validacion-calculos-incertidumbre-quimica-analitica-metodo-monte-carlo-parte2/) utilizaremos\nla librería `metRology` la cual incorpora la validación de GUM con MC en un \núnico comando `GUM.validate`... ¡y listo!.\n\nHasta la próxima.\n\n## Bibliografía\n\n1. Evaluation of measurement data – Guide to the expression of uncertainty in \nmeasurement JCGM 100:2008\n\n2. Evaluation of measurement data – Supplement 1 to the \"Guide to the expression \nof uncertainty in measurement\" – Propagation of distributions using a Monte Carlo \nmethod JCGM 101:2008\n\n3. Stephen L R Ellison _metRology: Support for Metrological Applications_\nR package version 0.9-23-2, 2016.\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}