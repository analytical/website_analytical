<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2017-09-23">

<title>Analytical - Validación de los cálculos de incertidumbre en química analítica con el método Monte Carlo. Parte II</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script src="../../site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="../../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
<link rel="stylesheet" href="../../custom.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title"><strong>Analytical</strong></span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../cursos.html" rel="" target="">
 <span class="menu-text">Cursos</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../libro.html" rel="" target="">
 <span class="menu-text">Libro</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">Quiénes somos</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto tools-wide">
    <a href="https://github.com/analytical/website_analytical" rel="" title="Código fuente" class="quarto-navigation-tool px-1" aria-label="Código fuente"><i class="bi bi-github"></i></a>
    <a href="https://www.linkedin.com/in/cjgomezs/" rel="" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-linkedin"></i></a>
    <a href="mailto:cvgomez@gmail.com" rel="" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-envelope"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#ejemplo-de-validación-de-cálculos-con-librería-metrology" id="toc-ejemplo-de-validación-de-cálculos-con-librería-metrology" class="nav-link active" data-scroll-target="#ejemplo-de-validación-de-cálculos-con-librería-metrology">Ejemplo de validación de cálculos con librería <code>metRology</code></a></li>
  <li><a href="#validación-de-los-cálculos-gum-con-el-método-de-monte-carlo" id="toc-validación-de-los-cálculos-gum-con-el-método-de-monte-carlo" class="nav-link" data-scroll-target="#validación-de-los-cálculos-gum-con-el-método-de-monte-carlo">Validación de los cálculos GUM con el método de Monte Carlo</a></li>
  <li><a href="#resumiendo" id="toc-resumiendo" class="nav-link" data-scroll-target="#resumiendo">Resumiendo</a></li>
  <li><a href="#bibliografía" id="toc-bibliografía" class="nav-link" data-scroll-target="#bibliografía">Bibliografía</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Validación de los cálculos de incertidumbre en química analítica con el método Monte Carlo. Parte II</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 23, 2017</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p>En el <a href="https://www.analytical.cl/post/validacion-calculos-incertidumbre-quimica-analitica-metodo-monte-carlo/">post anterior</a> describimos brevemente en qué consiste el método de Monte Carlo y cómo utilizarlo para estimar la incertidumbre de medición. Finalizamos comparando la estimación de acuerdo a la guía GUM con el método de Monte Carlo siguiendo estrictamente las directrices del test de diferencias numéricas propuesto por el Suplmento 1 de la GUM.</p>
<p>Llevamos a cabo el test de validación “a mano”, es decir, ingresamos todas las instrucciones en código <code>R</code>. Si bien no fue difícil, existen librerías especializadas en <code>R</code> que permiten realizar todos los cálculos de incertidumbre y validarlos utilizando funciones ya incorporadas.</p>
<p>En <code>R</code>existen dos librerías especializadas en cálculo de incertidumbre de métodos de medición físico-químicos:</p>
<ul>
<li><p><code>metRology</code> desarrollada en conjunto entre los Institutos Nacionales de Metrología del Reino Unido (LGC) y de Estados Unidos (NIST). Es mantenida por Steve Ellison, el autor de la guía GUM. Puede encontrar más información <a href="https://www.nist.gov/programs-projects/metrology-software-project">aquí</a>.</p></li>
<li><p><code>propagate</code> desarrollada por Andrej-Nikolai Spiess</p></li>
</ul>
<p>Me inclinaré por <code>metRology</code> principalmente porque tiene el soporte de los dos centros de metrología más imporantes a nivel mundial y, ya que fue desarrollada en sus inicios por Steve Ellison, tiene un pequeño sesgo hacia la metrología química.</p>
<section id="ejemplo-de-validación-de-cálculos-con-librería-metrology" class="level2">
<h2 class="anchored" data-anchor-id="ejemplo-de-validación-de-cálculos-con-librería-metrology">Ejemplo de validación de cálculos con librería <code>metRology</code></h2>
<p>Desarrollaremos un ejemplo más extenso sobre cálculo de incertidumbre en química analítica utilizando esta librería. Iremos paso a paso, cualquier duda en la implementación nada más escríbala en los comentarios más abajo. Sin embargo, no detallaremos cómo obtener las incertidumbres de cada uno de los factores involucrados en la ecuación de medición, sino que simplemente será un dato conocido para este ejemplo. En un futuro post, desarollaremos un ejemplo completo de principio a fin, por ahora nos centraremos en utilizar <code>metRology</code>como herramienta práctica.</p>
<p>En este ejemplo, calcularemos la incertidumbre de un método de determinación de cobre en mineral de cobre, con digestión ácida y cuantificación mediante espetroscopía de abosrción atómica AAS. Los detalles del método analítico están fuera del alcance de este post, pero pueden ser consultados en la norma chilena NCh 3392:2016.</p>
<blockquote class="blockquote">
<p>Seguiremos estrictamente las directrices de la GUM, por lo tanto, queda fuera de esta evaluación cualquier corrección de sesgo y/o recuperación. La discusión sobre si se debiera, o no, incorporar el sesgo en la incertidumbre es un tema que abordaremos en otro post.</p>
</blockquote>
<ol type="1">
<li>El primer paso para estimar la incertidumbre de este método es escribir la ecuación de medición:</li>
</ol>
<p><span class="math display">\[\begin{equation}
  \text{Cu}[\text{%}]=\frac{\text{C}_{\text{calib}}\cdot V \cdot D}{m\cdot 10000}
  (\#eq:medicion)
\end{equation}\]</span></p>
<p>donde <span class="math inline">\(\text{C}_{\text{calib}}\)</span> es la concentración de la muestra digerida interpolada en la curva de calibración <span class="math inline">\([\mu\text{g}\,\text{mL}^{-1}]\)</span>, <span class="math inline">\(m\)</span> es la masa de la muestra [g], <span class="math inline">\(V\,[\text{mL}]\)</span> es el volumen del aforo final y <span class="math inline">\(D\)</span> es un factor de dilución volumétrico, utilizado cuando es necesario. Para simplificar el problema, asumiremos que no hay dilución antes de la lectura por AAS, por lo tanto, <span class="math inline">\(D = 1\)</span> y <span class="math inline">\(u_{D} = 0\)</span>.</p>
<ol start="2" type="1">
<li>Identificación de las fuentes de incertidumbre</li>
</ol>
<p>A continuación se enumeran las fuentes de incertidumbre asociadas a cada uno de los factores de la ecuación @ref(eq:medicion) y se describe brevemente los métodos estadísticos y de juicio experto utilizados para obtener las incertidumbres estándar correpospondientes:</p>
<ul>
<li><span class="math inline">\(\text{C}_{\text{calib}}\)</span>: La incertidumbre estándar de la concentración de una muestra problema <span class="math inline">\(u_{\text{C}_\text{calib}}\)</span> obtenida de una curva de calibración lineal <span class="math inline">\(y = a + bx\)</span> es calculada a partir de la siguiente expresión:</li>
</ul>
<p><span class="math display">\[\begin{equation}
u_{\text{C}_{\text{calib}}}=\frac{s_{y/x}}{b}\sqrt{\frac{1}{m}+\frac{1}{n}+
\frac{(C_{\text{calib}}-\overline{C})^2}{\sum(C_{i}-\overline{C})^2}}
\label{eq:ucurva}
\end{equation}\]</span></p>
<p>donde <span class="math inline">\(s_{y/x}\)</span> es la desviación estándar de la regresión, <span class="math inline">\(m\)</span> es el número de replicados independientes de la muestra problema efectivamente analizados, <span class="math inline">\(n\)</span> es el número de calibrantes, <span class="math inline">\(C_{\text{calib}}\)</span> es la concentración de la muestra problema obtenida por interpolación en la curva de calibración, <span class="math inline">\(\overline{C}\)</span> es el promedio de la concentraciones de los calibrantes. Estos parámetros pueden ser obtenidos directamente del análisis estadístico de la curva de calibración lineal. Cabe destacar que cuando se utiliza el método de mínimos cuadrados ordinarios para estimar la pendiente e intercepto de la curva, esta metodología no incorpora la incertirtumbre de la concentración de los calibrantes.</p>
<p>{{% callout warning %}} Puede profundizar sobre la incertidumbre de calibración en el siguiente <a href="https://www.analytical.cl/post/como-calcular-la-incertidumbre-de-una-curva-de-calibracion/">post</a>{{% /callout %}}</p>
<ul>
<li><p><span class="math inline">\(V\)</span>: La incertidumbre del volumen de aforo <span class="math inline">\(u_{\text{V}}\)</span> es estimada a partir de la combinación de tres fuentes:</p>
<ul>
<li><p><span class="math inline">\(u_{\text{tol}}\)</span> La incertidumbre informada por el fabricante en el certificado original del lote de producción o aquella impresa en el material de vidrio. Esta incertidumbre es de Tipo B.</p></li>
<li><p><span class="math inline">\(u_{\text{rep}}\)</span> Incertidumbre debido a la repetibilidad de llenado del aforo del material de vidrio. Esta incertidumbre (Tipo A) es evaluada mediante métodos estadísticos a través de la replicación (<span class="math inline">\(n\)</span>) del llenado del material con agua destilada y el registro gravimétrico de la cantidad de agua. La incertidumbre estándar se expresa como la desviación estándar de los <span class="math inline">\(n\)</span> replicados.</p></li>
<li><p><span class="math inline">\(u_{\text{temp}}\)</span> La incertidumbre debido a la diferencia de temperatura registrada durante la calibración del material de vidrio y aquella que se registra durante los análisis de rutina. Esta incertidumbre expandida es expresada en la ecuación @ref(eq:uvol):</p></li>
</ul></li>
</ul>
<p><span class="math display">\[\begin{equation}
  U_{\text{temp}}= V\cdot \gamma_{\text{H}_{2}\text{O}} \cdot \Delta T
  (\#eq:uvol)
\end{equation}\]</span></p>
<p>donde <span class="math inline">\(V\)</span> es el volumen certificado del material de vidrio, <span class="math inline">\(\gamma_{\text{H}_{2}\text{O}} = 2.1\cdot 10^{-4}\,\text{°C}^{-1}\)</span> es el coeficiente de expansión del agua y <span class="math inline">\(\Delta T\)</span> es la variabilidad de la temperatura de trabajo del laboratorio en relación a la tempreratura de calibración del material. Finalmente, se obtiene asume una distribución rectangular de la variable obteniéndose una incertidumbre estándar <span class="math inline">\(u_{\text{temp}}=U_{\text{temp}}/\sqrt{3}\)</span> mL.</p>
<p>Esta expresión debe utilizarse cuando exista un certificado de calibración que informe la temperatura de referencia registrada durante el proceso de certificación el cual puede provenir del mismo fabricante o de alguna institución metrológica nacional que certifique este tipo material. Generalmente la temperatura de calibración se espcifica a 20°C.</p>
<p>La incertidumbre combinada estándar del volumen del aforo se obtiene a través de la siguiente expresión:</p>
<p><span class="math display">\[\begin{equation}
u_{\text{V}} = \sqrt{u_{\text{tol}}^2+u_{\text{rep}}^2+u_{\text{temp}}^2}
\end{equation}\]</span></p>
<ul>
<li><span class="math inline">\(m\)</span> : La incertidudmbre de la masa de la muestra es obtenida directamente del certificado de la balanza emitido por el nodo de metrología física nacional u otro proveedor de calibración.</li>
</ul>
<ol start="3" type="1">
<li>Cuantificación de los componentes de incertidumbre</li>
</ol>
<p>Como mencionamos anteriormente, no llevaremos a cabo la estimación de incertidumbre de cada uno de lo componentes, sino que asumiremos que estos datos ya están disponibles. Dedicaremos otro post a desarrollar un ejemplo completo de principio a fin.</p>
<ol start="4" type="1">
<li>Cálculo de la incertidumbre combinada total</li>
</ol>
<p>Aplicando las directrices de la GUM y en base a la ecuación de medición @ref(eq:medicion), la incertidumbre estándar de la concentración de Cu por este método analítico es obtenida a partir de:</p>
<p><span class="math display">\[\begin{equation}
u_{\text{Cu}} = \text{Cu}\sqrt{\left(\frac{u_{\text{C}_\text{calib}}}{\text{C}_{\text{calib}}}\right)^2+
\left(\frac{u_{\text{m}}}{m}\right)^2+
\left(\frac{u_{\text{V}}}{V}\right)^2}
(\#eq:ufinal)
\end{equation}\]</span></p>
<p>La tabla @ref(tab:udata) muestra las incertidumbres estándares de cada uno de los componentes de la ecuación @ref(eq:ufinal):</p>
<div class="cell">
<div class="cell-output-display">
<table class="table table-striped table-sm small" data-quarto-postprocess="true">
<caption>Valores e incertidumbres estándar de cada componente</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Componente</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Valor</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">u</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Unidades</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Concentracion calibracion</td>
<td style="text-align: left;">13.82</td>
<td style="text-align: left;">0.24</td>
<td style="text-align: left;">ug/mL</td>
</tr>
<tr class="even">
<td style="text-align: left;">Volumen aforo</td>
<td style="text-align: left;">250.00</td>
<td style="text-align: left;">0.14</td>
<td style="text-align: left;">mL</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Masa muestra</td>
<td style="text-align: left;">0.99160</td>
<td style="text-align: left;">0.00005</td>
<td style="text-align: left;">g</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Ok, vamos entonces a utilizar la librería <code>metRology</code> para evaluar la incertidumbre del % de Cu.</p>
<p>{{% callout warning %}} Debe, en primer lugar, instalar la librería mediante el comando <code>install.packages('metRology')</code>{{% /callout %}}</p>
<p>Una vez instalada debe ingresar el siguiente código <code>R</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(metRology)  <span class="co"># Carga la librería metRology</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Ingresar los valores de cada variable input (Tabla 1)</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>Cu.calib <span class="ot">&lt;-</span> <span class="fl">13.82</span> <span class="co"># Concentración interpolada en la curva de calibración [ug/mL]</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>V <span class="ot">&lt;-</span> <span class="dv">250</span>          <span class="co"># Volumen de aforo [mL]</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fl">0.9916</span>       <span class="co"># Masa de la muestra [g]</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>D <span class="ot">&lt;-</span> <span class="dv">1</span>            <span class="co"># Factor de dilución (D = 1 implica no hay dilución)</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Ingresar las incertidumbres estándar de cada variable input (Tabla 1)</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Se mantienen, obviamente, las mismas unidades</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>u.Cu.calib <span class="ot">&lt;-</span> <span class="fl">0.24</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>u.V <span class="ot">&lt;-</span> <span class="fl">0.14</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>u.m <span class="ot">&lt;-</span> <span class="fl">0.00005</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>u.D <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Ingresamos la ecuación de medición y la guardamos con el nombre C.Cu</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># mediante el comando 'expression'</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>C.Cu <span class="ot">&lt;-</span> <span class="fu">expression</span>(Cu.calib<span class="sc">*</span>V<span class="sc">*</span>D<span class="sc">/</span>(m<span class="sc">*</span><span class="dv">10000</span>))</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Guardemos en una lista los valores de cada variable input, la llamaremos</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># x.Cu</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>x.Cu <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Cu.calib =</span> Cu.calib, <span class="at">V =</span> V , <span class="at">D =</span> D, <span class="at">m =</span> m)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Guardemos en un vector las incertidumbres estándares de cada variable input</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co"># ¡¡en el mismo orden que fueron ingresadas en x.Cu!!</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Llamaremos a este vector u.x.Cu</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>u.x.Cu <span class="ot">&lt;-</span> <span class="fu">c</span>(u.Cu.calib, u.V, u.D, u.m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>¡Estamos listos! Ahora <code>metRology</code>hará todo el trabajo con el comando <code>uncert</code>, Ud. debe elegir cuál método de estimación desea utilizar, las opciones son:</p>
<ul>
<li>GUM</li>
<li>Monte Carlo</li>
<li>Kragten: Método numérico basado en una aproximación de las derivadas parciales propuestas por GUM. Es una excelente alternativa y muy sencilla de implementar en Excel también.</li>
<li>NUM y k2 son otras aproximaciones numéricas de derivadas parciales.</li>
</ul>
<ol type="1">
<li>Cálculo de incertidumbre de acuerdo a GUM:</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ingresamos ¡en este orden! los siguientes parámetros del comando uncert</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Ecuación de medición C.Cu</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Lista de valores inputs x.Cu</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Vector de incertidumbres estándar u.x.Cu</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ¿Con cuál método quiere calcular la incertidumbre? En este caso GUM</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>u.Cu.GUM <span class="ot">&lt;-</span> <span class="fu">uncert</span>(C.Cu, x.Cu, u.x.Cu, <span class="at">method =</span> <span class="st">'GUM'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>La información que entrega <code>uncert</code>es muy completa, sin embargo, para nuestro propósito sólo debemos fijarnos en el resultado que aparece al final del análisis, es decir: <span class="math inline">\(y = 0.3484268\)</span> % Cu y <span class="math inline">\(u(y) = 0.006054\)</span> % Cu.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
Uncertainty evaluation

Call:
  uncert.expression(obj = C.Cu, x = x.Cu, u = u.x.Cu, method = "GUM")

Expression: Cu.calib * V * D/(m * 10000)

Evaluation method:  GUM 

Uncertainty budget:
         x        u       c            u.c          
Cu.calib  13.8200 0.24000  0.025211779  6.050827e-03
V        250.0000 0.14000  0.001393707  1.951190e-04
D          1.0000 0.00000  0.348426785  0.000000e+00
m          0.9916 0.00005 -0.351378363 -1.756892e-05

   y:  0.3484268
u(y):  0.006053998 </code></pre>
</div>
</div>
<p>Además de los cálculos de incertidumbre, la opción <code>method = 'GUM'</code> entrega 4 gráficos muy interesantes, siendo el más importante el de <em>Contribuciones combinadas</em>, el cual se muestra en la figura @ref(fig:plotGUM). En este gráfico queda en evidencia que el factor que más aporta a la incertidumbre total (evaluada por GUM) es la curva de calibración.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/plotGUM-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Gráfico de contribución a la incertidumbre total</figcaption>
</figure>
</div>
</div>
</div>
<ol start="2" type="1">
<li>Cálculo de incertidumbre de acuerdo a Monte Carlo:</li>
</ol>
<p>Esencialmente es el mismo comando que utilizamos para GUM, sólo que seleccionaremos <code>method = 'MC'</code>. Sin embargo, este método tiene varias opciones adicionales muy interesantes:</p>
<ul>
<li><p>Con la opción <code>distrib</code> Ud. puede asignar a cada variable su respectiva distribución de probabilidad: Normal, uniforme, triangular o Student. Por defecto, asume que todas son normales.</p></li>
<li><p>Con la opción <code>B</code> indica el número de simulaciones. Por defecto <code>B = 200</code>. Le sugiero cambiar a <code>B = 10000</code>.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Guardaremos los cálculos en el objeto u.Cu.MC</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co"># Sólo para que Ud. obtenga los mismos resultados</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>u.Cu.MC <span class="ot">&lt;-</span> <span class="fu">uncert</span>(C.Cu, x.Cu, u.x.Cu, <span class="at">method =</span> <span class="st">'MC'</span>, <span class="at">B =</span> <span class="dv">10000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>El método de Monte Carlo entrega el siguiente análisis:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
Uncertainty evaluation

Call:
  uncert.expression(obj = C.Cu, x = x.Cu, u = u.x.Cu, method = "MC",     B = 10000)

Expression: Cu.calib * V * D/(m * 10000)

Evaluation method:  MC 

Budget:
         x        u       c            u.c           distrib
Cu.calib  13.8200 0.24000  0.025211842  6.050842e-03 norm   
V        250.0000 0.14000  0.001393355  1.950696e-04 norm   
D          1.0000 0.00000           NA            NA norm   
m          0.9916 0.00005 -0.351680471 -1.758402e-05 norm   
         distrib.pars         
Cu.calib mean=13.82, sd=0.24  
V        mean=250, sd=0.14    
D        mean=1, sd=0         
m        mean=0.9916, sd=5e-05

   y:  0.3484268
u(y):  0.006046603 

Monte Carlo evaluation using 10000 replicates:

   y:
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.3252  0.3444  0.3484  0.3484  0.3525  0.3720 </code></pre>
</div>
</div>
<p>El MMC obtiene <span class="math inline">\(y = 0.3484268\)</span> % Cu y <span class="math inline">\(u(y) = 0.0060466\)</span> % Cu.</p>
<p>La tabla @ref(tab:comparacion) muestra la comparación de ambas aproximaciones en la estimación de la incertidumbre estándar:</p>
<div class="cell">
<div class="cell-output-display">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<caption>Cuadro comparativo GUM v/s Monte Carlo % Cu</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Método</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Valor calculado</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">u</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">GUM</td>
<td style="text-align: left;">0.3484268</td>
<td style="text-align: left;">0.0060540</td>
</tr>
<tr class="even">
<td style="text-align: left;">Monte Carlo</td>
<td style="text-align: left;">0.3484268</td>
<td style="text-align: left;">0.0060466</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Note la excelente concordancia entre ambas metodologías <strong>para esta ecuación de medición asumiendo una distribución normal para todas las variables inputs</strong>. En este caso, <em>muy particular</em>, casi sería innecesario validar el método GUM, pero lo haremos de todas maneras para ejemplificar la operación.</p>
</section>
<section id="validación-de-los-cálculos-gum-con-el-método-de-monte-carlo" class="level2">
<h2 class="anchored" data-anchor-id="validación-de-los-cálculos-gum-con-el-método-de-monte-carlo">Validación de los cálculos GUM con el método de Monte Carlo</h2>
<p>En el <a href="https://www.analytical.cl/post/validacion-calculos-incertidumbre-quimica-analitica-metodo-monte-carlo/">post anterior</a> hicimos el test de validación numérica “a mano”, en esta oportunidad utilizaremos el comando <code>GUM.validate</code>. Lamentablemente este comando tiene una forma distinta de ingresar los parámetros, nada del otro mundo, pero es distinta a <code>uncert</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Si bien GUM.validate tiene muchas opciones, utilizaremos aquellas</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># que están por defecto en la librería</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Guarde en un vector el nombre de las variables, cada una entre ' '</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>variables <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'Cu.calib'</span>, <span class="st">'V'</span>, <span class="st">'D'</span>, <span class="st">'m'</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Guarde en un vector x.i los valores de la variables input en el </span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># mismo orden que ingresó 'variables' arriba</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>x.i <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">13.82</span>, <span class="dv">250</span>, <span class="dv">1</span>, <span class="fl">0.9916</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Guarde en un vector u.i las incertidumbres estándar de las variables</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co"># input, en el mismo orden que ingresó 'variables' arriba</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>u.i <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.24</span>, <span class="fl">0.14</span>, <span class="dv">0</span>, <span class="fl">0.00005</span>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Guarde los grados de libertad de cada variable input como nu.i. </span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co"># En este ejemplo  asumiremos que todas tienen infinitos grados de </span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co"># libertad (nu = 9999)</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>nu.i <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">9999</span>, <span class="dv">9999</span>, <span class="dv">9999</span>, <span class="dv">9999</span>)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Seleccione que tipo de método utilizó para evaluar cada una de las</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="co"># incertidumbres: Tipo A o tipo B. En este caso sólo la incertidumbre</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="co"># de calibración u.Cu.calib es de tipo A.</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>type <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'A'</span>, <span class="st">'B'</span>, <span class="st">'B'</span>, <span class="st">'B'</span>)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Seleccione que distribuciones de probabilidad asignó a las variables</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="co"># input. En este ejemplo, asumiremos que todas son normales</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>distribution <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="st">'Normal'</span>, <span class="dv">4</span>) <span class="co"># Repetir Normal 4 veces (soy muy flojo)</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Guarde la ecuación de medición entre ''</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>ec_de_medicion <span class="ot">&lt;-</span> <span class="st">'Cu.calib*V*D/(m*10000)'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Listo, ahora validemos los cálculos GUM con el comando <code>GUM.validate</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">126</span>) <span class="co"># Tu ya sabes</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">GUM.validate</span>(<span class="at">var.name =</span> variables, </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">x.i =</span> x.i,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">u.i =</span> u.i,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">nu.i =</span> nu.i,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> type,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">distribution =</span> distribution,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">measurement.fnc =</span> ec_de_medicion)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.958</code></pre>
</div>
</div>
<p>“Bueno ¿Y?” se preguntará Ud.</p>
<p>Bien, para validar el método GUM frente a Monte Carlo, fíjese en el valor que entrega <code>GUM.validate = 0.958</code> y compárelo con 0.95. Si el valor de <code>GUM.validate</code> <span class="math inline">\(&gt; 0.95\)</span> entonces el método GUM queda validado.</p>
<p>En el fondo, <code>GUM.validate</code> evalúa si el intervalo de incertidumbre calculado por GUM alcanza o no la cobertura esperada del 95% (teórica).</p>
</section>
<section id="resumiendo" class="level2">
<h2 class="anchored" data-anchor-id="resumiendo">Resumiendo</h2>
<ol type="1">
<li><p>El método de Monte Carlo funciona en casos donde las suposiciones del método GUM no se cumplen, especialmente en ecuaciones de medición no lineales.</p></li>
<li><p>Mientras más divergencia de la linealidad tenga el modelo de medición, más discrepancias habrá entre ambos métodos.</p></li>
<li><p>Es posible que cuando incorpore distribuciones rectangulares (uniformes), el histograma de los valores de Monte Carlo esté dominado por este tipo de distribuciones. Verá un achatamiento del histograma.</p></li>
<li><p>Ya hablamos que la pureza química (al menos para compuestos muy puros <span class="math inline">\(&gt; 95\%\)</span>) no es correcto modelarla mediante una distribución Normal (¿<span class="math inline">\(99.7 \pm 0.5\)</span> %?), sino con una Beta. Lamentablmente, la librería <code>metRology</code>no posee esta distribución en sus opciones y tendrá que hacer la simulación “a mano”.</p></li>
<li><p>En general para distribuciones de Monte Carlos muy asimétricas (como la pureza química modelada con Beta), la diferencia entre MC y GUM se verá reflejada en la incertidumbre expandida y no en la estándar.</p></li>
<li><p>Quedan muchas cosas por analizar del método de Monte Carlo, sin embargo, el espíritu de este post es divulgar a la comunidad químico-analítica esta poderosa herramienta más que entrar en los detalles teóricos.</p></li>
<li><p>Usamos el lenguaje <code>R</code>porque es actualmente el <em>idioma oficial</em> de la estadística. Sin embargo, Ud. puede implementar estos cálculos en cualquier lenguaje e incluso en Excel. Además, existen muchos otros softwares que, aunque no tan flexibles y potentes como <code>R</code>, harán el trabajo. Revise la siguiente lista en <a href="https://en.wikipedia.org/wiki/List_of_uncertainty_propagation_software">Wikipedia</a>.</p></li>
</ol>
<p>Espero que este post haya sido de su agrado, todos los comentarios son bienvenidos. Hasta la próxima.</p>
</section>
<section id="bibliografía" class="level2">
<h2 class="anchored" data-anchor-id="bibliografía">Bibliografía</h2>
<ol type="1">
<li><p>Evaluation of measurement data – Guide to the expression of uncertainty in measurement JCGM 100:2008</p></li>
<li><p>Evaluation of measurement data – Supplement 1 to the “Guide to the expression of uncertainty in measurement” – Propagation of distributions using a Monte Carlo method JCGM 101:2008</p></li>
<li><p>Stephen L R Ellison <em>metRology: Support for Metrological Applications</em> R package version 0.9-23-2, 2016.</p></li>
</ol>


</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Copyright 2024, Carlos Gómez</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/analytical/website_analytical">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/cjgomezs/">
      <i class="bi bi-linkedin" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>