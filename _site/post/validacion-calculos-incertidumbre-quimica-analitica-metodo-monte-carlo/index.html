<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.541">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2017-09-12">

<title>Analytical - Validación de los cálculos de incertidumbre en química analítica con el método Monte Carlo. Parte I</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../img/icon_analytical.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-KT9C16VQJX"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-KT9C16VQJX', { 'anonymize_ip': true});
</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
<link rel="stylesheet" href="../../custom.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title"><strong>Analytical</strong></span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../cursos.html"> 
<span class="menu-text">Cursos</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../libro.html"> 
<span class="menu-text">Libro</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">Quiénes somos</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools tools-wide">
    <a href="https://github.com/analytical/website_analytical" title="Código fuente" class="quarto-navigation-tool px-1" aria-label="Código fuente"><i class="bi bi-github"></i></a>
    <a href="https://www.linkedin.com/in/cjgomezs/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-linkedin"></i></a>
    <a href="mailto:<cvgomez@gmail.com>" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-envelope"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#qué-es-el-método-de-monte-carlo" id="toc-qué-es-el-método-de-monte-carlo" class="nav-link active" data-scroll-target="#qué-es-el-método-de-monte-carlo">¿Qué es el método de Monte Carlo?</a></li>
  <li><a href="#incertidumbre-de-un-factor-de-dilución" id="toc-incertidumbre-de-un-factor-de-dilución" class="nav-link" data-scroll-target="#incertidumbre-de-un-factor-de-dilución">Incertidumbre de un factor de dilución</a>
  <ul class="collapse">
  <li><a href="#método-gum" id="toc-método-gum" class="nav-link" data-scroll-target="#método-gum">Método GUM</a></li>
  <li><a href="#método-de-monte-carlo" id="toc-método-de-monte-carlo" class="nav-link" data-scroll-target="#método-de-monte-carlo">Método de Monte Carlo</a></li>
  <li><a href="#bibliografía" id="toc-bibliografía" class="nav-link" data-scroll-target="#bibliografía">Bibliografía</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Validación de los cálculos de incertidumbre en química analítica con el método Monte Carlo. Parte I</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 12, 2017</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>De acuerdo al numeral 8.1 del Suplemento 1 de la guía GUM, el método de Monte Carlo es un método general para estimar la incertidumbre de medición y puede, bajo ciertas directrices, validar los cálculos realizados con el método GUM. En este post asumiremos que Ud., esimado lector, está familiarizado con el método GUM y ya lo tiene implementado , por ejemplo, en una hoja Excel y le gustaría validar sus cálculos mediante un método totalmente independiente y más general. De esta forma podrá cumplir cabalmente con el siguiente numeral de la norma 17025:</p>
<blockquote class="blockquote">
<p>5.4.7.1 Los cálculos y la transferencia de los datos deben estar sujetos a verificaciones adecuadas llevadas a cabo de una manera sistemática.</p>
</blockquote>
<p>¿Cómo sabe Ud. que su implementación en Excel está correcta?</p>
<section id="qué-es-el-método-de-monte-carlo" class="level1">
<h1>¿Qué es el método de Monte Carlo?</h1>
<p>(Aquí podría hacer copy-paste de Wikipedia…no olvidar borrar esta nota interna)</p>
<p>Muy sucintamente, el método de Monte Carlo es un método numérico que permite evaluar expresiones matemáticas complejas (muy complejas, créame) mediante la simulación de números aleatorios. Este post no pretende profundizar en la teoría de este método (ZzzZzz…) , sino más bien dar ejemplos concretos aplicados en química analítica, por lo tanto, es posible que un avezado estadístico computacional le dé un infarto al leer la soltura con la cual me expreso y lo ineficiente del código <code>R</code>. El objetivo es simplemente la divulgación a la comunidad químico-analítica para abordar algunos puntos normativos de la 17025 y guía GUM.</p>
<p>Veamos un ejemplo sencillo. Supongamos que necesitamos calcular la incertidumbre de la suma de 2 variables aleatorias normales <strong>independientes</strong>, y que poseen<br>
la misma media (<span class="math inline">\(\mu\)</span>) y varianza (<span class="math inline">\(\sigma^2\)</span>), es decir, si <span class="math inline">\(Z = X + Y\)</span> ¿Cuál es la incertiumbre de <span class="math inline">\(Z\)</span>? (<span class="math inline">\(u_{Z}\)</span>)</p>
<p>Si Ud. recuerda de sus cursos de probabilidades, este problema tiene una solución directa y sencilla:</p>
<p><span class="math display">\[\begin{eqnarray}
  V(Z) &amp;=&amp; V(X) + V(Y) \\
  V(Z) &amp;=&amp; \sigma^2 + \sigma^2 \\
  V(Z) &amp;=&amp; 2\sigma^2
\end{eqnarray}\]</span></p>
<p>donde <span class="math inline">\(V()\)</span> denota varianza. Por lo tanto, la incertidumbre de Z es <span class="math inline">\(u_{Z} = \sqrt{V(Z)} = \sqrt{2}\sigma\)</span>. Si Ud, conoce <span class="math inline">\(\sigma\)</span>, es decir, la incertidumbre estándar de <span class="math inline">\(X\)</span> e <span class="math inline">\(Y\)</span>, el problema está resuelto. En realidad, este ejemplo es bastente general y las distribuciones ni siquiera tienen que ser las mismas, bajo ciertas condiciones, esto se cumplirá.</p>
<p>Pero supongamos que, repentinamente, Ud. olvidó todo lo aprendido en esas estimulantes clases de probabilidades con 33°C y sin aire acondicionado. No se preocupe, obtendremos la incertidumbre de Z sin recurrir a ninguna propiedad teórica de las varianzas. Usareemos el método de Monte Carlo, para lo cual debemos hacer lo siguiente:</p>
<ol type="1">
<li><p>Asigne a cada variable, en este caso <span class="math inline">\(X\)</span> e <span class="math inline">\(Y\)</span>, una distribución de probabilidad de acuerdo a la información que disponga hasta ese momento. En nuestro ejemplo tanto <span class="math inline">\(X\)</span> como <span class="math inline">\(Y\)</span> son normales con la misma media (<span class="math inline">\(\mu\)</span>) y desviación estándar (<span class="math inline">\(\sigma\)</span>). Sin pérdida de generalidad, diremos que ambas variables <span class="math inline">\(X\)</span> e <span class="math inline">\(Y\)</span> son normales con media <span class="math inline">\(\mu = 100\)</span> y desviación estándar <span class="math inline">\(\sigma = 5\)</span>.</p></li>
<li><p>De cada variable genere un valor aleatorio. Es decir, en nuestro ejemplo debemos generar un número aleatorio para <span class="math inline">\(X\)</span> y otro para <span class="math inline">\(Y\)</span> a partir de sus respectivas distribuciones de probabilidad asignadas, que en este caso es la misma. Haremos esto en lenguaje <code>R</code>:</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generamos n = 1 número aletorio para X a partir de una</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># distribución Normal con media 100 y desviación estándar 5</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">100</span>, <span class="dv">5</span>) </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Generamos n = 1 número aletorio para Y a partir de una</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># distribución Normal con media 100 y desviación estándar 5</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">100</span>, <span class="dv">5</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>En esta primera simulación obtuvimos <span class="math inline">\(X = 97.1976218\)</span> e <span class="math inline">\(Y = 98.8491126\)</span>.</p>
<ol start="3" type="1">
<li><p>Calcule la variable de interés con los datos simulados. En el ejemplo, <span class="math inline">\(Z = X + Y = 97.1976218 + 98.8491126= 196.0467343\)</span></p></li>
<li><p>Repita los pasos 2 y 3 <span class="math inline">\(n\)</span> veces y obtenga la distribución empírica de <span class="math inline">\(Z\)</span>.</p></li>
<li><p>A partir de los <span class="math inline">\(n\)</span> datos simulados de <span class="math inline">\(Z\)</span>, estime <span class="math inline">\(u_{Z} = s_{Z}\)</span>, es decir, la desviación estándar muestral de los <span class="math inline">\(n\)</span> datos.</p></li>
</ol>
<p>Hay varias formas de implementar todos estos pasos en <code>R</code>, la más intuitiva (creo yo) es la siguiente:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">1000</span> <span class="co"># Obtendremos n = 1000 datos aleatorios para X e Y</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="co"># Media mu = 100</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="dv">5</span>    <span class="co"># Desviación estandar s = 5</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, mu, s) <span class="co"># 1000 datos aleatorios de una normal con parámetros mu y s</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, mu, s) <span class="co"># 1000 datos aleatorios de una normal con parámetros mu y s</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>Z <span class="ot">&lt;-</span> X <span class="sc">+</span> Y <span class="co"># Para cada uno de los 1000 datos de X e Y, calculamos Z</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>uZ <span class="ot">&lt;-</span> <span class="fu">sd</span>(Z) <span class="co"># La incertidumbre estándar de Z es la desviación estándar de las</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>            <span class="co"># n = 1000 simulaciones</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>En nuestro ejemplo, la incertidumbre estándar por Monte Carlo es de <span class="math inline">\(u_{Z}^{MC} = 7.4\)</span>. ¿Qué nos decía la teoría? Que <span class="math inline">\(u_{Z} = \sqrt{2}\sigma = \sqrt{2}\cdot 5 = 7.1\)</span></p>
<p>Ojalá todo fuera tan fácil. El ejemplo era muy sencillo y la solución es conocida en forma teórica. La vida del químico analítico es extremadamente compleja (en todo $entido), y no siempre existe una solución tan simple. Para eso está el método de Monte Carlo, el cual simula un proceso complejo cuyas variables de entrada pueden tener cualquier distribución de probabilidad tal como lo muestra la siguiente figura:</p>
<p><img src="mc2.png" class="img-fluid" width="500"></p>
<p>La generalidad del método MC no asume normalidad de la variable de interés <span class="math inline">\(g(y)\)</span>, sino más bien la estima como una distribución empírica y a partir de ésta calcula la incertidumbre estándar y expandida.</p>
</section>
<section id="incertidumbre-de-un-factor-de-dilución" class="level1">
<h1>Incertidumbre de un factor de dilución</h1>
<p>Para aterrizar esta definición veamos un ejemplo muy simple en química analítica y cómo podemos implementarlo en un lenguaje de programación especialmente dedicado a esta tareas: <code>R</code>. A su vez discutiremos las principales diferencias entre el método GUM y el método de Monte Carlo</p>
<blockquote class="blockquote">
<p>Se prepara la dilución de una muestra antes de su lectura por AAS, mediante la toma de una alícuota de 20 mL con una pipeta volumétrica cuyo volumen es <span class="math inline">\(20,0 \pm 0,1\)</span> mL y su dilución en un matraz de 100 mL, con un volumen de <span class="math inline">\(100 \pm 0,6\)</span> mL. Calcular la incertidumbre del factor de dilución <span class="math inline">\(f = V_{final}/V_{inicial}\)</span></p>
</blockquote>
<section id="método-gum" class="level2">
<h2 class="anchored" data-anchor-id="método-gum">Método GUM</h2>
<p>Este es un ejercicio bastante simple para el método GUM, pues el factor de dilución es una operación de división, por lo que aplicando las reglas de propagación de la incertidumbre de una división, obtenemos lo siguiente:</p>
<p><span id="eq-f"><span class="math display">\[
  u_{f} = f\sqrt{\left(\frac{u_{V_{final}}}{V_{final}}\right)^2 +
  \left(\frac{u_{V_{inicial}}}{V_{incial}}\right)^2}
\tag{1}\]</span></span></p>
<p>Asumiremos por simplicidad que las incertidumbres asociadas al material volumétrico son las indicadas por el fabricante en el mismo material, es decir, de acuerdo a la figura <a href="#fig-matraz" class="quarto-xref">1</a> y, por ahora, serán las únicas fuentes de incertidumbre del material volumétrico (olvidaremos la T° y la repetibilidad).</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-matraz" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-matraz-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="pipeta.jpg" class="img-fluid figure-img" width="84">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-matraz-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figura&nbsp;1: Incertidumbre del fabricante
</figcaption>
</figure>
</div>
</div>
</div>
<p>Ahora bien, las incertidumbres del material volumétrico corresponden a incertidumbres expandidas <span class="math inline">\(U\)</span>, por lo tanto, debemos convertirlas a incertidumbres estándares antes de aplicar la ecuación <a href="#eq-f" class="quarto-xref">1</a>. También por simplicidad, modelaremos los volúmenes mediante una distribución rectangular, por lo tanto, al estandarizar <span class="math inline">\(u = U/k\)</span>, con <span class="math inline">\(k = \sqrt{3}\)</span> obtenemos lo siguiente:</p>
<p><span class="math display">\[
\begin{eqnarray}
  u_{V_{final}} &amp;=&amp; \frac{0,6}{\sqrt{3}} = 0.35\, \text{mL}\\
  u_{V_{incial}} &amp;=&amp; \frac{0,1}{\sqrt{3}} = 0.06\, \text{mL}\\
  u_{f} &amp;=&amp; \frac{100}{20}\sqrt{\left(\frac{0.35}{100}\right)^2 +
  \left(\frac{0.06}{20}\right)^2} \\
    u_{f} &amp;=&amp;  0.02255
\end{eqnarray}
\]</span></p>
<p>En este ejemplo, podemos asumir que los grados de libertad de ambas incertidumbres tienden a infinito, por lo tanto, si queremos obtener la incertidumbre expandida del factor de dilución con un 95% de confianza, se asume un factor de cobertura <span class="math inline">\(k = 2\)</span>, de esta forma obtenemos <span class="math inline">\(U_{f} = ku_{f} = 0.04509\)</span> mL.</p>
</section>
<section id="método-de-monte-carlo" class="level2">
<h2 class="anchored" data-anchor-id="método-de-monte-carlo">Método de Monte Carlo</h2>
<p>Implementaremos en <code>R</code>, los pasos descritos del método de Monte Carlo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="dv">3</span>) <span class="co"># Factor de estandarización para una distribución rectangular</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>vi <span class="ot">&lt;-</span> <span class="dv">20</span>     <span class="co"># Volumen inicial [mL]</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>Uvi <span class="ot">&lt;-</span> <span class="fl">0.1</span>   <span class="co"># Incertidumbre expandida del volumen inicial [mL]</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>uvi <span class="ot">&lt;-</span> Uvi<span class="sc">/</span>k <span class="co"># Incertidumbre estándar del volumen inicial [mL]</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>vf <span class="ot">&lt;-</span> <span class="dv">100</span>    <span class="co"># Volumen incial [mL]</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>Uvf <span class="ot">&lt;-</span> <span class="fl">0.6</span>   <span class="co"># Incertidumbre expandida del volumen final [mL]</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>uvf <span class="ot">&lt;-</span> Uvf<span class="sc">/</span>k <span class="co"># Incertidumbre estándar del volumen final [mL]</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Aquí haremos la simulación de Monte Carlo</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co"># Para que Ud. obtenga los mismos resultados en su simulación</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Generaremos valores aleatorios de volumen inicial y volumen final</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># desde una distribución rectangular con el comando runif(n, minimo, maximo)</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co"># minimo = volumen - U</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co"># maximos = volumen + U</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Los guardaremos en los vectores vi.sim y vf.sim</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>vi.sim <span class="ot">&lt;-</span> <span class="fu">runif</span>(n, vi <span class="sc">-</span> Uvi, vi <span class="sc">+</span> Uvi)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>vf.sim <span class="ot">&lt;-</span> <span class="fu">runif</span>(n, vf <span class="sc">-</span> Uvf, vf <span class="sc">+</span> Uvf)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Ahora calcularemos el factor de dilución para cada uno de los pares de </span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co"># valores de volumen inicial y final que simulamos y lo guardaremos en el</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co"># el vector f.sim</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>f.sim <span class="ot">&lt;-</span> vf.sim<span class="sc">/</span>vi.sim <span class="co"># Es la misma fórmula</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>“Bueno ¿Y?” se preguntará Ud.</p>
<p>Veamos que hemos generado con la simulación:</p>
<ol type="1">
<li><span class="math inline">\(n = 1000\)</span> valores aleatorios del volumen inicial a partir de una distribución rectangular con media <code>vi</code> = 20 mL e incertidumbre expandida <code>Uvi</code> = 0.1 mL. El promedio de los 1000 volumenes iniciales simulados es 19.999 mL y una desviación estándar de <code>uvi</code> = <span class="math inline">\(U_{vf}/\sqrt{3} = 0.058\)</span> mL. La figura <a href="#fig-visim" class="quarto-xref">2</a> muestra el histograma de los valores simulados. Note que la simulación concuerda perfectamente con los valores de incertidumbre informados por el fabricante (<span class="math inline">\(20 \pm 0.1\)</span> mL).</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<div id="fig-visim" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-visim-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-visim-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-visim-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figura&nbsp;2: Histograma de los valores simulados de volumen inicial [mL]
</figcaption>
</figure>
</div>
</div>
</div>
<ol start="2" type="1">
<li><p><span class="math inline">\(n = 1000\)</span> valores aleatorios del volumen final a partir de una distribución rectangular con media <code>vf</code> = 100 mL e incertidumbre expandida <code>Uvf</code> = 0.6 mL.</p></li>
<li><p>Para cada uno de los pares datos simulados de volumen inicial y final, se calculó el factor de dilución, por lo tanto, se obtuvieron en total <span class="math inline">\(n = 1000\)</span> factores los cuales se “guardaron” en el vector <code>f.sim</code>, tal como se muestra en la tabla <strong>?@tbl-fsi</strong>:</p></li>
</ol>
<div class="cell">
<div id="tbl-fsim" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-fsim-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Tabla&nbsp;1: Variables simuladas. Se muestran los primeros 6 datos
</figcaption>
<div aria-describedby="tbl-fsim-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">vf.sim</th>
<th style="text-align: left;">vi.sim</th>
<th style="text-align: left;">f.sim</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">99.73</td>
<td style="text-align: left;">19.96</td>
<td style="text-align: left;">5.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">100.11</td>
<td style="text-align: left;">20.06</td>
<td style="text-align: left;">4.99</td>
</tr>
<tr class="odd">
<td style="text-align: left;">99.59</td>
<td style="text-align: left;">19.98</td>
<td style="text-align: left;">4.98</td>
</tr>
<tr class="even">
<td style="text-align: left;">100.42</td>
<td style="text-align: left;">20.08</td>
<td style="text-align: left;">5.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">100.42</td>
<td style="text-align: left;">20.09</td>
<td style="text-align: left;">5.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">99.97</td>
<td style="text-align: left;">19.91</td>
<td style="text-align: left;">5.02</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<ol start="4" type="1">
<li>La figura <a href="#fig-fsimhis" class="quarto-xref">3</a> muestra el histograma de los 1000 factores de dilución simulados:</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<div id="fig-fsimhis" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-fsimhis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-fsimhis-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-fsimhis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figura&nbsp;3: Histograma de factores de dilución simulados
</figcaption>
</figure>
</div>
</div>
</div>
<p>“¡Qué interesante!”, dirá Ud., la división de dos variables rectangulares genera una distribución de datos que, al menos, es simétrica. ¿Es razonable asumir una distribución normal del factor de dilución simulado? Si recuerda la discusión en este <a href="https://www.analytical.cl/post/mis-datos-no-son-normales/">post</a>, podemos evaluar la admisibilidad de esta hipótesis mediante el análisis gráfico <em>QQ-Plot</em> de normalidad de los datos simulados y el test de Shapiro, el cual se muestra en la figura <a href="#fig-fsimnorm" class="quarto-xref">4</a>.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  f.sim
W = 0.99005, p-value = 2.719e-06</code></pre>
</div>
<div class="cell-output-display">
<div id="fig-fsimnorm" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-fsimnorm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-fsimnorm-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-fsimnorm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figura&nbsp;4: QQ-Plot de normalidad de los n factores de dilución simulados
</figcaption>
</figure>
</div>
</div>
</div>
<p>Aparentemente, el modelo normal sería razonable para modelar el factor de dilución sino fuera por los siguientes hechos:</p>
<ul>
<li>El histograma del factor de dilución tiene “colas livianas”, lo cual se puede advertir en el <em>QQ-plot</em> de normalidad en los valores extremos.</li>
</ul>
<ul>
<li><p>La evidencia del test de Shapiro en contra de la hipótesis de normalidad.</p></li>
<li><p>Y lo más importante, la razón de dos variables independientes rectangulares (uniformes) teóricamente no es Normal (está demostrado).</p></li>
</ul>
<p>Ok, probablemente esta discusión no sea de mucho interés por ahora, pero nos dará pistas para dirigir la discusión posterior.</p>
<blockquote class="blockquote">
<p>Entonces ¿Cómo obtenemos la incertidumbre del factor de dilución por el método de Monte Carlo?</p>
</blockquote>
<p>Muy sencillo, a partir de la desviación estándar de los factores de dilución simulados, es decir, <span class="math inline">\(u_{f}^{MC} = 0.02302\)</span>. Como podrá advertir, es muy similar a la obtenida por el método GUM <span class="math inline">\(u_{f} = 0.02255\)</span>, la diferencia relativa es de un 2.1 %. Es más, ajustando a las cifras significativas correctas se obtiene la misma magnitud 0.02</p>
<blockquote class="blockquote">
<p>¿Queda validado el método GUM con los cálculos del método de Monte Carlo? Desde el punto de vista metrológico químico: Sí. Desde el punto de vista numérico: Depende.</p>
</blockquote>
<p>Lo que sucede es que el numeral 8.1 del suplemento 1 dela guía GUM es explícito en establecer un criterio de aceptación entre el método GUM y el método de Monte Carlo (MC):</p>
<p><span class="math display">\[\begin{eqnarray}
  |y - U(y) - y_{low}| &amp;&lt;&amp; \xi \\
  |y + U(y) - y_{high}| &amp;&lt;&amp; \xi
\end{eqnarray}\]</span></p>
<p>donde <span class="math inline">\(y \pm U(y)\)</span> es el valor calculado de la variable y su incertidumbre expandida estimada por el método GUM; <span class="math inline">\(y_{low}\)</span> e <span class="math inline">\(y_{high}\)</span> corresponden a los percentiles 2.5 y 97.5 de los datos simulados, es decir, el intervalo de incertidumbre al 95% de confianza calculado por el método de Monte Carlo. <span class="math inline">\(\xi\)</span> es la tolerancia numérica entre ambas metodologías de cálculo. Es decir, es un test de precisión numérica, no metrológica.</p>
<p>El valor de <span class="math inline">\(\xi\)</span> está relacionado las cifras significativas que tienen sentido físico-químico y metrológico. Por ejemplo, si para una gravimetría usamos una balanza granataria cuya incertidumbre es del orden de <span class="math inline">\(\pm 0.1\)</span> g, no podríamos elegir una tolerancia numérica de <span class="math inline">\(0.00001\)</span> g. Para establecer <span class="math inline">\(\xi\)</span> la guía indica lo siguiente:</p>
<ol type="1">
<li><p>Exprese <span class="math inline">\(u(y)\)</span> en notación científica manteniendo las cifras significativas. En nuestro caso obtuvimos <span class="math inline">\(u_{f} = 0.0225\)</span>, la cual puede ser redondeada a una cifra significativa <span class="math inline">\(u_{f} = 0.02\)</span>. Esta incertidumbre, entonces, se expresa como <span class="math inline">\(2 \cdot 10^{-2}\)</span>.</p></li>
<li><p>Para obtener <span class="math inline">\(\xi\)</span>, utilice el exponente de la potencia de 10 (t = -2) del paso anterior, en la siguiente expresión:</p></li>
</ol>
<p><span class="math display">\[\begin{eqnarray}
  \xi &amp;=&amp; \frac{1}{2}\times 10^{t} \\
  \xi &amp;=&amp; \frac{1}{2}\times 10^{-2}\\
  \xi &amp;=&amp; 0.005
\end{eqnarray}\]</span></p>
<blockquote class="blockquote">
<p>¿Cómo obtenemos los percentiles 2.5 y 97.5 de la simulación de Monte Carlo?</p>
</blockquote>
<p>Muy sencillo, con el comando <code>quantile</code>:</p>
<p>Esto quiere decir, que de los <span class="math inline">\(n = 1000\)</span> datos simulados del factor de dilución, un 95% se encuentra dentro del intervalo [4.96, 5.04]. La figura <a href="#fig-quantilofig" class="quarto-xref">5</a> muestra este intervalo en el histograma de los datos simulados:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(f.sim, </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">'Factor de dilución'</span>,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">''</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">freq =</span> T,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">breaks =</span> <span class="dv">20</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="fl">4.93</span>, <span class="fl">5.07</span>))</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> quantilos[<span class="dv">1</span>], <span class="at">col =</span> <span class="st">'red'</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> quantilos[<span class="dv">2</span>], <span class="at">col =</span> <span class="st">'red'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-quantilofig" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-quantilofig-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-quantilofig-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-quantilofig-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figura&nbsp;5: Intervalo de confianza al 95% de los datos simulados del factor de dilución
</figcaption>
</figure>
</div>
</div>
</div>
<p>Por lo tanto, sólo nos queda calcular <span class="math inline">\(U(y)\)</span> que es la incertidumbre expandida del factor de dilución calculada por el método GUM. De acuerdo a la guía <span class="math inline">\(U = k\cdot u\)</span>, donde <span class="math inline">\(k\)</span> es el factor de cobertura para obtener un intervalo de incertidumbre con cierto grado de confianza. Aquí es donde la guía GUM asume, bajo ciertas condiciones (ver numeral G.2.3), que la variable de respuesta, en este caso factor de dilución, puede aproximarse a una distribución Normal donde <span class="math inline">\(k \approx 2\)</span>. Advierta que para nuestro ejemplo esta suposición no tiene mucho asidero. Por lo tanto, siguiendo las directrices de la guía GUM <span class="math inline">\(U_{f} = 2\cdot 0.023 = 0.05\)</span>.</p>
<p>Con todos los datos estimados, llevemos a cabo el test de validación entre el método GUM y el método de Monte Carlo:</p>
<p><span class="math display">\[\begin{eqnarray}
  |5 - 0.045 - 4.957| &amp;&lt;&amp; 0.005 \\
  |5 + 0.045 - 5.043| &amp;&lt;&amp; 0.005
\end{eqnarray}\]</span></p>
<blockquote class="blockquote">
<p>En ambos casos <span class="math inline">\(0.002 &lt; 0.005\)</span>, por lo tanto, el método GUM queda validado</p>
</blockquote>
<p><em>Insisto con lo del mago Tamariz: ¡chiararáaa!</em></p>
<p>Observaciones:</p>
<ol type="1">
<li><p>Si bien en este ejemplo sólo utilizamos <span class="math inline">\(n = 1000\)</span> simulaciones, en la práctica se requieren muchas más (<span class="math inline">\(10^{5} - 10^{6}\)</span>). El suplemento 1 de la GUM entrega más directrices en este tema.</p></li>
<li><p>Mientras mayor sea el grado de no linealidad de la ecuación de medición, más divergencias habrá entre GUM y MC. Siendo este último el de mayor generalidad.</p></li>
<li><p>Si bien se puede implementar Monte Carlo en Excel, es una tarea bastante engorrosa pues debe programarlo en Visual Basic. Le sugiero utilizar lenguajes de programación más modernos como <code>R</code> o <code>Python</code>, los cuales tienen librerías especializadas en métodos de simulación.</p></li>
<li><p>A mayor asimetría de la distribución empírica, mayores diferencias habrá entre ambos métodos.</p></li>
<li><p>Dé un sentido químico a la simulación ¿<a href="https://www.analytical.cl/post/mis-datos-no-son-normales/">Recuerda que la pureza química no es Normal</a>? Intente con la distribución Beta la cual es más apropiada para modelar pureza.</p></li>
</ol>
<p>En este post hemos validado el método GUM frente a Monte Carlo “a mano”, es decir, hemos hecho el test en forma manual. En el <a href="https://www.analytical.cl/post/validacion-calculos-incertidumbre-quimica-analitica-metodo-monte-carlo-parte2/">próximo post</a> utilizaremos la librería <code>metRology</code> la cual incorpora la validación de GUM con MC en un único comando <code>GUM.validate</code>… ¡y listo!.</p>
<p>Hasta la próxima.</p>
</section>
<section id="bibliografía" class="level2">
<h2 class="anchored" data-anchor-id="bibliografía">Bibliografía</h2>
<ol type="1">
<li><p>Evaluation of measurement data – Guide to the expression of uncertainty in measurement JCGM 100:2008</p></li>
<li><p>Evaluation of measurement data – Supplement 1 to the “Guide to the expression of uncertainty in measurement” – Propagation of distributions using a Monte Carlo method JCGM 101:2008</p></li>
<li><p>Stephen L R Ellison <em>metRology: Support for Metrological Applications</em> R package version 0.9-23-2, 2016.</p></li>
</ol>


</section>
</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright 2024, Carlos Gómez</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/analytical/website_analytical">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/cjgomezs/">
      <i class="bi bi-linkedin" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>